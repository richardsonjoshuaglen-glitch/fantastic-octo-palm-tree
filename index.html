<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>Rigging CG Helper — Simple 2-Pick</title>
<style>
  :root{
    --bg:#ffffff; --ink:#111; --panel:#f6f8fa; --border:#e9ecef; --accent:#0d6efd;
    --pickL:#ffd60a; --pickR:#32cd32; --roll:#5bc0ff;
  }
  body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin:16px; color:var(--ink); background:var(--bg); }
  h1 { font-size:20px; margin:0 0 10px; display:flex; align-items:center; gap:10px;}
  .badge{display:inline-block; padding:2px 8px; border-radius:999px; background:#d1e7dd; color:#0f5132; font-weight:700; font-size:12px;}
  fieldset { border:1px solid #ccc; border-radius:10px; margin:10px 0; padding:10px 12px; }
  legend { padding:0 6px; font-weight:600; }
  label { display:block; margin:6px 0 2px; font-size:14px; }
  select, input[type="number"] { width:100%; font-size:16px; padding:10px 12px; box-sizing:border-box; border-radius:8px; border:1px solid #cfd4d9; }
  .row { display:grid; grid-template-columns:1fr 1fr; gap:10px; }
  .btn { display:inline-block; padding:10px 12px; margin:8px 6px 0 0; border-radius:10px; background:var(--accent); color:#fff; border:none; font-size:16px; cursor:pointer;}
  .btn.secondary{ background:#6c757d; }
  .items{ margin-top:6px;}
  .item{ padding:8px; border:1px dashed #999; border-radius:8px; margin-bottom:8px; font-size:14px;}
  .out{ background:var(--panel); padding:12px; border-radius:10px; border:1px solid var(--border); line-height:1.5; font-size:15px;}
  .out h3{ margin:6px 0; font-size:16px;}
  .pill{ display:inline-block; padding:2px 8px; border-radius:999px; font-weight:600; font-size:12px; color:#000;}
  .pill.left{ background:var(--pickL); } .pill.right{ background:var(--pickR); } .pill.roll{ background:var(--roll); }
  #sheet{ width:100%; max-width:1000px; background:#fff; border:1px solid #ddd; border-radius:8px; display:block;}
  .muted{ color:#555; font-size:12px; }
  #debug{ margin-top:6px; font-size:12px; color:#b00020; white-space:pre-wrap; border:1px dashed #ddd; padding:6px; border-radius:6px;}
</style>
</head>
<body>
<h1>Rigging CG Helper — Simple 2-Pick <span class="badge" id="badge">JS not ready</span></h1>

<!-- OUTPUT FIRST -->
<fieldset>
  <legend>Output (quick)</legend>
  <div id="summary" class="out">Add items and click “Compute + Draw”.</div>
  <div class="muted">Legend: <span class="pill left">Left pick</span> <span class="pill right">Right pick</span> · “Left Edge” = minimum coordinate on the chosen pick axis.</div>
</fieldset>

<!-- PICK SETUP -->
<fieldset>
  <legend>Pick setup (always 2 picks)</legend>
  <div class="row">
    <label>Pick axis (auto chooses the largest span if set to Auto)
      <select id="pickAxis">
        <option value="AUTO" selected>Auto (largest span)</option>
        <option value="X">X+ Left → Right / X− Right → Left</option>
        <option value="Y">Y+ Toward / Y− Away</option>
        <option value="Z">Z+ Up / Z− Down</option>
      </select>
    </label>
    <label>Pick spacing (in)
      <input id="pickSpacing" type="number" inputmode="decimal" value="72">
    </label>
  </div>
  <div class="row">
    <label>Minimum clearance to fittings (in)
      <input id="minClear" type="number" inputmode="decimal" value="6">
    </label>
    <label>Pipe OD (for roll readout; in)
      <input id="pipeOD" type="number" inputmode="decimal" value="24">
    </label>
  </div>
  <div class="muted">Pick spacing is kept at 72″ by default. The solver slides the pair left/right to avoid being within the minimum clearance of any valve, elbow, tee, or coupling.</div>
</fieldset>

<!-- ADD ITEMS -->
<fieldset>
  <legend>Add item</legend>
  <div class="row">
    <label>Item type
      <select id="itemType">
        <option value="P">24″ pipe (per-inch)</option>
        <option value="V">24″ valve (regular)</option>
        <option value="C">24″ coupling (weight only)</option>
        <option value="E">24″ 90° elbow</option>
        <option value="F">24″ 45° elbow</option>
        <option value="T">24″ tee (plain)</option>
        <option value="W">24″ tee with valve</option>
        <option value="X">Custom per-inch</option>
        <option value="Y">Custom fixed</option>
        <!-- Inline valve intentionally removed -->
      </select>
    </label>
    <label>Orientation (axis + layman direction)
      <select id="orient">
        <option value="A" selected>A — X+ (Left → Right)</option>
        <option value="B">B — X− (Right → Left)</option>
        <option value="C">C — Y+ (Toward)</option>
        <option value="D">D — Y− (Away)</option>
        <option value="E">E — Z+ (Up)</option>
        <option value="F">F — Z− (Down)</option>
      </select>
    </label>
  </div>
  <div class="row" id="lenRow">
    <label>Length (in)
      <input id="lenIn" type="number" inputmode="decimal" value="60">
    </label>
    <label id="wpiLabel">Weight per inch (lb/in)
      <input id="wpi" type="number" inputmode="decimal" value="8.2">
    </label>
  </div>
  <div class="row" id="fixedRow" style="display:none">
    <label>Total weight (lb)
      <input id="fixedW" type="number" inputmode="decimal" value="0">
    </label>
    <label>Effective length along chosen axis (in)
      <input id="fixedL" type="number" inputmode="decimal" value="0">
    </label>
  </div>

  <button class="btn" id="addBtn" type="button">Add item</button>
  <button class="btn secondary" id="clearBtn" type="button">Clear list</button>

  <div class="items" id="items"></div>
  <div id="debug">debug: (ready)</div>
</fieldset>

<button class="btn" id="computeBtn" type="button">Compute + Draw</button>
<button class="btn secondary" id="downloadBtn" type="button" disabled>Download PNG</button>

<!-- DRAWINGS -->
<fieldset>
  <legend>Drawings</legend>
  <canvas id="sheet"></canvas>
  <div class="muted">Plan (X–Y) and Elevation (X–Z). Pick markers shown on the chosen axis’ zero line.</div>
</fieldset>

<script>
/* ---------- Setup ---------- */
(function(){ var b=document.getElementById('badge'); if(b) b.textContent='Ready (simple 2-pick)'; })();
function el(id){ return document.getElementById(id); }
function setupCanvas(canvas, cssW, cssH){
  cssW=cssW||1000; cssH=cssH||900;
  var dpr=window.devicePixelRatio||1;
  canvas.style.width=cssW+'px'; canvas.style.height=cssH+'px';
  canvas.width=Math.floor(cssW*dpr); canvas.height=Math.floor(cssH*dpr);
  var ctx=canvas.getContext('2d'); ctx.setTransform(dpr,0,0,dpr,0,0); ctx.textBaseline='top'; return ctx;
}
var sheet=el('sheet'), ctx=setupCanvas(sheet);

/* ---------- Constants ---------- */
var PIPE_DIAM_IN=24.0;
var W_PER_IN_DEFAULT=8.2;
var W_EL90=475.0, S_EL90=36.0;
var W_EL45=240.0, S_EL45=15.0;
var W_COUP=115.0;
var W_VALVE_BODY=451.0, L_VALVE_STD=12.0;
var W_TEE_BODY=477.0, L_TEE=20.0;

/* Colors */
var COLORS={
  axisX:'#d12222', axisY:'#2a9d2a', axisZ:'#1f6feb',
  P:'#666666', E:'#2aa198', F:'#2aa198', V:'#ff9100', C:'#8e44ad', T:'#d33682', W:'#d33682', X:'#8d6e63', Y:'#8d6e63',
  pickLeft:getComputedStyle(document.documentElement).getPropertyValue('--pickL')||'#ffd60a',
  pickRight:getComputedStyle(document.documentElement).getPropertyValue('--pickR')||'#32cd32',
  pipeBand:'rgba(100,100,100,0.18)', centerline:'#000'
};

/* Helpers */
var ORIENTS={ A:[ 1,0,0], B:[-1,0,0], C:[ 0,1,0], D:[ 0,-1,0], E:[ 0,0,1], F:[ 0, 0,-1] };
function r4(x){ return Math.round(x*4)/4; }
function r8(x){ return Math.round(x*8)/8; }
function fmtFtIn(x){
  var v=r4(x), ft=Math.floor(v/12), rem=v-ft*12;
  var whole=Math.floor(rem), frac=Math.round((rem-whole)*100)/100;
  var map={"0":"", "0.25":"-1/4", "0.5":"-1/2", "0.75":"-3/4"};
  var tag=(map.hasOwnProperty(String(frac))?map[String(frac)]:null);
  var inch=(tag!==null)? (whole+tag+'"') : (rem.toFixed(2)+'"');
  return ft? (ft+"' "+inch) : inch;
}

/* ---------- State ---------- */
var items=[], segments=[], marks=[];

/* ---------- UI wiring ---------- */
window.addEventListener('load', function(){
  el('itemType').addEventListener('change', updateDetailRows);
  el('addBtn').addEventListener('click', addItem);
  el('clearBtn').addEventListener('click', resetAll);
  el('computeBtn').addEventListener('click', computeAndDraw);
  el('downloadBtn').addEventListener('click', function(){
    var a=document.createElement('a');
    var ts=new Date().toISOString().slice(0,19).replace(/[:T]/g,'-');
    a.download=ts+'_rigging.png'; a.href=sheet.toDataURL('image/png'); a.click();
  });
  updateDetailRows();
});

function updateDetailRows(){
  var t=el('itemType').value;
  el('lenRow').style.display = (t==='P'||t==='X')?'grid':'none';
  el('wpiLabel').style.display = (t==='P'||t==='X')?'block':'none';
  el('fixedRow').style.display = (t==='Y')?'grid':'none';
}

/* ---------- Geometry building ---------- */
function getEnd(){ return segments.length===0?[0,0,0]:segments[segments.length-1].end.slice(); }
function pushSegment(tCode, dir, L, labelIdx){
  var s=getEnd(), e=[s[0]+dir[0]*L, s[1]+dir[1]*L, s[2]+dir[2]*L];
  segments.push({tCode:tCode, start:s, end:e});
  var mid=[(s[0]+e[0])/2,(s[1]+e[1])/2,(s[2]+e[2])/2];
  marks.push([labelIdx, mid[0], mid[1], mid[2]]);
}

/* Add items (inline valve removed) */
function addItem(){
  try{
    var t=el('itemType').value, idx=items.length+1, d=ORIENTS[el('orient').value]||[1,0,0];

    function placeLinear(name, L, W, xcgLocal, tCode){
      L=Math.max(0, Number(L)||0);
      if(xcgLocal==null) xcgLocal=L/2;
      items.push({name:name, length:L, weight:W, xcg_local:xcgLocal, tCode:tCode});
      pushSegment(tCode, d, L, idx);
    }

    if(t==='P'){ // per-inch pipe
      var L=Number(el('lenIn').value)||0, wpi=Number(el('wpi').value)||W_PER_IN_DEFAULT;
      var W=wpi*L; placeLinear('24" pipe', L, W, null, 'P');
      addItemRow(idx, `Pipe ${L.toFixed(1)} in @ ${wpi} → ${W.toFixed(1)} lb`);

    }else if(t==='X'){ // custom per-inch
      var Lx=Number(el('lenIn').value)||0, wpiX=Number(el('wpi').value)||W_PER_IN_DEFAULT;
      var WX=wpiX*Lx; placeLinear('Custom per-inch', Lx, WX, null, 'X');
      addItemRow(idx, `Custom per-inch ${Lx.toFixed(1)} in @ ${wpiX} → ${WX.toFixed(1)} lb`);

    }else if(t==='Y'){ // custom fixed
      var WY=Number(el('fixedW').value)||0, LY=Number(el('fixedL').value)||0;
      placeLinear('Custom fixed', LY, WY, null, 'Y');
      addItemRow(idx, `Custom fixed ${WY.toFixed(1)} lb, eff L=${LY.toFixed(1)} in`);

    }else if(t==='V'){ // valve regular (+ coupling mass at the right joint later)
      var LV=L_VALVE_STD, WV=W_VALVE_BODY;
      placeLinear('Valve (regular)', LV, WV, LV/2, 'V');
      addItemRow(idx, `Valve reg L=${LV} in, W=${WV.toFixed(1)} lb`);

    }else if(t==='C'){ // coupling (weight-only), stub for visibility
      items.push({name:'Coupling', length:0, weight:W_COUP, xcg_local:0, tCode:'C'});
      pushSegment('C', d, 1, idx);
      addItemRow(idx, `Coupling W=${W_COUP.toFixed(1)} lb`);

    }else if(t==='E'){ // 90 elbow (+ coupling at right joint later)
      placeLinear('90° elbow', S_EL90, W_EL90, S_EL90/2, 'E');
      addItemRow(idx, `90° elbow L=${S_EL90} in, W=${W_EL90.toFixed(1)} lb`);

    }else if(t==='F'){ // 45 elbow
      placeLinear('45° elbow', S_EL45, W_EL45, S_EL45/2, 'F');
      addItemRow(idx, `45° elbow L=${S_EL45} in, W=${W_EL45.toFixed(1)} lb`);

    }else if(t==='T'){ // tee (plain)
      placeLinear('Tee (plain)', L_TEE, W_TEE_BODY, L_TEE/2, 'T');
      addItemRow(idx, `Tee L=${L_TEE} in, W=${W_TEE_BODY.toFixed(1)} lb`);

    }else if(t==='W'){ // tee with valve (treated as one part)
      var LW=L_TEE, WT=W_TEE_BODY+W_VALVE_BODY;
      var xcg=(W_TEE_BODY*(LW/2)+W_VALVE_BODY*(LW/2))/WT;
      placeLinear('Tee + valve', LW, WT, xcg, 'W');
      addItemRow(idx, `Tee + valve L=${LW} in, W=${WT.toFixed(1)} lb`);
    }

    el('debug').textContent='debug: items='+items.length;
  }catch(e){
    el('debug').textContent='debug: addItem error: '+e;
  }
}
function addItemRow(idx, txt){
  var d=document.createElement('div'); d.className='item'; d.textContent=(idx+'. '+txt); el('items').appendChild(d);
}

function resetAll(){
  items=[]; segments=[]; marks=[];
  el('items').innerHTML='';
  el('summary').innerHTML='Add items and click “Compute + Draw”.';
  ctx.clearRect(0,0,sheet.width,sheet.height);
  el('debug').textContent='debug: reset';
}

/* ---------- CG (with joint couplings) ---------- */
function addV(a,b){ return [a[0]+b[0],a[1]+b[1],a[2]+b[2]]; }
function mulV(a,k){ return [a[0]*k,a[1]*k,a[2]*k]; }
function computeCG(){
  var totalW=0, sum=[0,0,0];
  for(var i=0;i<items.length;i++){
    var w=items[i].weight, p=[marks[i][1],marks[i][2],marks[i][3]];
    totalW += w; sum = addV(sum, mulV(p, w));
  }
  // auto coupling at every joint between items (not before the first)
  for(var j=0;j<segments.length-1;j++){
    var end=segments[j].end;
    totalW += W_COUP; sum = addV(sum, mulV(end, W_COUP));
  }
  return {CG: totalW? mulV(sum,1/totalW) : [0,0,0], totalW: totalW};
}

/* ---------- Axis utilities ---------- */
function extentAlong(axisIndex){
  var arr=[]; for(var i=0;i<segments.length;i++){ arr.push(segments[i].start[axisIndex], segments[i].end[axisIndex]); }
  var mn=Math.min.apply(null,arr), mx=Math.max.apply(null,arr);
  return {min:mn, max:mx, span:mx-mn};
}
function chooseAxis(sel){
  if(sel!=='AUTO') return sel;
  var exX=extentAlong(0), exY=extentAlong(1), exZ=extentAlong(2);
  var best='X', span=exX.span;
  if(exY.span>span){ best='Y'; span=exY.span; }
  if(exZ.span>span){ best='Z'; span=exZ.span; }
  return best;
}

/* ---------- Forbidden windows (6" from fittings/couplings) ---------- */
var FIT_TOKENS = new Set(['V','E','F','T','W','C']);
function buildForbidden(axisIndex, clearance){
  var out=[];
  for(var i=0;i<segments.length;i++){
    var seg=segments[i], code=(items[i]||{}).tCode || seg.tCode;
    if(!FIT_TOKENS.has(code)) continue; // pipes and custom-per-inch/fixed are OK
    var s=seg.start[axisIndex], e=seg.end[axisIndex];
    var a=Math.min(s,e)-clearance, b=Math.max(s,e)+clearance;
    out.push([a,b]);
  }
  // merge overlaps
  out.sort(function(A,B){return A[0]-B[0];});
  var merged=[];
  for(var k=0;k<out.length;k++){
    if(merged.length===0 || out[k][0]>merged[merged.length-1][1]){
      merged.push(out[k].slice());
    }else{
      merged[merged.length-1][1]=Math.max(merged[merged.length-1][1], out[k][1]);
    }
  }
  return merged;
}
function pointAllowed(x, windows){ for(var i=0;i<windows.length;i++){ if(x>=windows[i][0] && x<=windows[i][1]) return false; } return true; }

/* Slide the 72" pair left/right to avoid forbidden zones, keep spacing */
function placeTwoPicks(ext, spacing, leftInit, windows){
  var step=0.5, maxShift=ext.span+120; // generous search
  function ok(left){
    var right=left+spacing;
    if(left<ext.min || right>ext.max) return false;
    return pointAllowed(left, windows) && pointAllowed(right, windows);
  }
  if(ok(leftInit)) return {left:leftInit, right:leftInit+spacing};

  for(var k=1; k*step<=maxShift; k++){
    var d=k*step;
    var L1=leftInit-d, L2=leftInit+d;
    if(ok(L1)) return {left:L1, right:L1+spacing};
    if(ok(L2)) return {left:L2, right:L2+spacing};
  }
  // fallback: clamp inside ext, ignore windows if impossible
  var Lf=Math.max(ext.min, Math.min(ext.max-spacing, leftInit));
  return {left:Lf, right:Lf+spacing, note:'Could not clear all fittings with spacing fixed.'};
}

/* ---------- Compute & Draw ---------- */
function computeAndDraw(){
  if(items.length===0){ alert('Add at least one item.'); return; }

  var cgInfo=computeCG(), CG=cgInfo.CG, totalW=cgInfo.totalW;
  var axis=chooseAxis(el('pickAxis').value), ax=(axis==='X'?0:(axis==='Y'?1:2));
  var ext=extentAlong(ax);

  var spacing = Math.max(1, Number(el('pickSpacing').value)||72);
  spacing = Math.min(spacing, Math.max(1, ext.span)); // keep inside span

  // target centered about CG on chosen axis
  var leftInit = Math.max(ext.min, Math.min(ext.max-spacing, CG[ax]-spacing/2));

  var windows = buildForbidden(ax, Math.max(0, Number(el('minClear').value)||6));
  var picks = placeTwoPicks(ext, spacing, leftInit, windows);

  // roll readout (just info)
  var R=(Number(el('pipeOD').value)||PIPE_DIAM_IN)/2;
  var y=CG[1]; var yclamped=Math.max(-R, Math.min(R, y));
  var rollDeg = (R>0)? (Math.asin(yclamped/R)*180/Math.PI) : 0;
  var rollSide = (y>0?'toward +Y':(y<0?'toward -Y':'no roll needed'));
  var arc = R * (Math.abs(rollDeg)*Math.PI/180);

  // Output
  var minEdge=ext.min;
  var html='';
  html += '<h3>Totals</h3>';
  html += '<div>Total weight: <b>'+totalW.toFixed(1)+' lb</b></div>';
  html += '<div>CG (in): X=<b>'+CG[0].toFixed(2)+'</b>, Y=<b>'+CG[1].toFixed(2)+'</b>, Z=<b>'+CG[2].toFixed(2)+'</b></div>';
  html += '<h3>Pick Points — axis '+axis+' (from Left Edge)</h3>';
  html += '<div><span class="pill left">Left pick</span> '+fmtFtIn(picks.left - minEdge)+'</div>';
  html += '<div><span class="pill right">Right pick</span> '+fmtFtIn(picks.right - minEdge)+'</div>';
  html += '<div>Pick spacing: '+fmtFtIn(spacing)+'</div>';
  if(picks.note){ html += '<div class="muted">'+picks.note+'</div>'; }
  html += '<h3>Roll (info)</h3>';
  html += '<div><span class="pill roll">Roll</span> ≈ '+rollDeg.toFixed(1)+'° '+rollSide+'; circumference offset per choker ≈ '+(r8(arc)).toFixed(3).replace(/\.000$/,'')+'"</div>';
  el('summary').innerHTML = html;

  drawAll(axis, picks);
  el('downloadBtn').disabled=false;
}

/* ---------- Drawing ---------- */
function drawAll(axis, picks){
  ctx=setupCanvas(sheet, 1000, 1000);
  var W=1000,H=1000,pad=28, secH=Math.floor((H-pad*3)/2);
  var planRect={x:pad,y:pad,w:W-2*pad,h:secH};
  var elevRect={x:pad,y:pad*2+secH,w:W-2*pad,h:secH};

  ctx.fillStyle='#fff'; ctx.fillRect(0,0,W,H);

  var verts=[[0,0,0]]; for(var i=0;i<segments.length;i++){ verts.push(segments[i].end.slice()); }
  var px=verts.map(v=>v[0]), py=verts.map(v=>v[1]), pz=verts.map(v=>v[2]);
  drawProjection(planRect, px, py, 'Plan (X–Y)', axis, picks, 'XY');
  drawProjection(elevRect, px, pz, 'Elevation (X–Z)', axis, picks, 'XZ');
}

function drawProjection(rect, px, py, title, axis, picks, plane){
  var minX=Math.min.apply(null, px.concat([0])), maxX=Math.max.apply(null, px.concat([1]));
  var minY=Math.min.apply(null, py.concat([-1])), maxY=Math.max.apply(null, py.concat([1]));

  var pad=46, sx=(rect.w-pad*2)/((maxX-minX)||1), sy=(rect.h-pad*2)/((maxY-minY)||1), s=Math.min(sx,sy);
  function mapX(x){ return rect.x+pad+(x-minX)*s; }
  function mapY(y){ return rect.y+rect.h-pad-(y-minY)*s; }

  ctx.fillStyle='#000'; ctx.font='18px system-ui'; ctx.fillText(title, rect.x, rect.y-6);

  // axes
  ctx.lineWidth=2;
  ctx.strokeStyle=COLORS.axisX; ctx.beginPath(); ctx.moveTo(mapX(minX), mapY(0)); ctx.lineTo(mapX(maxX), mapY(0)); ctx.stroke();
  ctx.strokeStyle=(plane==='XY')?COLORS.axisY:COLORS.axisZ;
  var x0=mapX(0); ctx.beginPath(); ctx.moveTo(x0, mapY(minY)); ctx.lineTo(x0, mapY(maxY)); ctx.stroke();

  // pipe band (thickness) then colored centerlines
  var thickness=Math.min(28, Math.max(8, s*24*0.6)); ctx.lineCap='round';
  segments.forEach(function(seg){
    var sx0=mapX(seg.start[0]), sy0=mapY(plane==='XY'?seg.start[1]:seg.start[2]);
    var sx1=mapX(seg.end[0]),   sy1=mapY(plane==='XY'?seg.end[1]:seg.end[2]);
    ctx.strokeStyle=COLORS.pipeBand; ctx.lineWidth=thickness; ctx.beginPath(); ctx.moveTo(sx0,sy0); ctx.lineTo(sx1,sy1); ctx.stroke();
  });
  segments.forEach(function(seg){
    var sx0=mapX(seg.start[0]), sy0=mapY(plane==='XY'?seg.start[1]:seg.start[2]);
    var sx1=mapX(seg.end[0]),   sy1=mapY(plane==='XY'?seg.end[1]:seg.end[2]);
    ctx.strokeStyle=COLORS[seg.tCode]||COLORS.centerline; ctx.lineWidth=3; ctx.beginPath(); ctx.moveTo(sx0,sy0); ctx.lineTo(sx1,sy1); ctx.stroke();
  });

  // segment labels
  ctx.fillStyle='#000'; ctx.font='13px system-ui';
  for(var m=0;m<marks.length;m++){
    var mk=marks[m]; var x=mk[1], y=(plane==='XY'?mk[2]:mk[3]);
    ctx.fillText(String(mk[0]), mapX(x)+4, mapY(y)-16);
  }

  // pick markers on the chosen axis zero line (for visibility)
  var zeroY = (axis==='X') ? 0 : (plane==='XY' ? (axis==='Y'?0:NaN) : (axis==='Z'?0:NaN));
  if(!Number.isNaN(zeroY)){
    // leaders
    drawTopPill(rect.x+12, rect.y+10, 120, 20, COLORS.pickLeft,  'Left pick');
    drawTopPill(rect.x+142, rect.y+10, 130, 20, COLORS.pickRight, 'Right pick');
    drawLeader(rect.x+72, rect.y+28, mapX(picks.left),  mapY(zeroY), COLORS.pickLeft);
    drawLeader(rect.x+202,rect.y+28, mapX(picks.right), mapY(zeroY), COLORS.pickRight);
    drawPickMarker(mapX(picks.left),  mapY(zeroY), COLORS.pickLeft,  'L');
    drawPickMarker(mapX(picks.right), mapY(zeroY), COLORS.pickRight, 'R');
  }

  // border
  ctx.strokeStyle='#cfd4d9'; ctx.lineWidth=1; ctx.strokeRect(rect.x,rect.y,rect.w,rect.h);

  function drawTopPill(x,y,w,h,color,label){
    ctx.fillStyle=color; ctx.strokeStyle=color; var r=h/2;
    ctx.beginPath(); ctx.moveTo(x+r,y); ctx.lineTo(x+w-r,y);
    ctx.arc(x+w-r,y+r,r,-Math.PI/2,Math.PI/2);
    ctx.lineTo(x+r,y+h); ctx.arc(x+r,y+r,r,Math.PI/2,Math.PI*1.5);
    ctx.closePath(); ctx.fill(); ctx.fillStyle='#000'; ctx.font='12px system-ui'; ctx.fillText(label, x+8, y+3);
  }
  function drawLeader(x1,y1,x2,y2,color){
    ctx.strokeStyle=color; ctx.lineWidth=2; ctx.beginPath(); ctx.moveTo(x1,y1); ctx.lineTo(x2,y2); ctx.stroke();
  }
  function drawPickMarker(x,y,color,label){
    ctx.strokeStyle=color; ctx.fillStyle=color;
    ctx.beginPath(); ctx.moveTo(x,y-14); ctx.lineTo(x,y-2); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(x,y-2); ctx.lineTo(x-6,y-8); ctx.moveTo(x,y-2); ctx.lineTo(x+6,y-8); ctx.stroke();
    ctx.beginPath(); ctx.arc(x,y,4,0,Math.PI*2); ctx.fill();
    ctx.fillStyle='#000'; ctx.font='12px system-ui'; ctx.fillText(label, x+6, y-16);
  }
}

/* ---------- Utility ---------- */
function dist3(a,b){ var dx=b[0]-a[0], dy=b[1]-a[1], dz=b[2]-a[2]; return Math.sqrt(dx*dx+dy*dy+dz*dz); }

/* ---------- END ---------- */
</script>
</body>
</html>
