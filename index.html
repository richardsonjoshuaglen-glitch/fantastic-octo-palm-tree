<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>Rigging CG Helper — v12 (Auto Choker Placement + Directional XYZ)</title>
<style>
  :root{
    --bg:#ffffff; --ink:#111; --panel:#f6f8fa; --border:#e9ecef; --accent:#0d6efd;
    --roll:#5bc0ff; --pickL:#ffd60a; --pickR:#32cd32;
  }
  body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin:16px; color:var(--ink); background:var(--bg); }
  h1 { font-size:20px; margin:0 0 10px; display:flex; align-items:center; gap:10px;}
  .badge{display:inline-block; padding:2px 8px; border-radius:999px; background:#d1e7dd; color:#0f5132; font-weight:700; font-size:12px;}
  fieldset { border:1px solid #ccc; border-radius:10px; margin:10px 0; padding:10px 12px; }
  legend { padding:0 6px; font-weight:600; }
  label { display:block; margin:6px 0 2px; font-size:14px; }
  select, input[type="number"], input[type="text"] { width:100%; font-size:16px; padding:10px 12px; box-sizing:border-box; border-radius:8px; border:1px solid #cfd4d9; }
  .row { display:grid; grid-template-columns:1fr 1fr; gap:10px; }
  .row3{ display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px; }
  .btn { display:inline-block; padding:10px 12px; margin:8px 6px 0 0; border-radius:10px; background:var(--accent); color:#fff; border:none; font-size:16px; cursor:pointer;}
  .btn.secondary{ background:#6c757d; }
  #sheet{ width:100%; max-width:1000px; background:#fff; border:1px solid #ddd; border-radius:8px; display:block;}
  .items{ margin-top:6px;}
  .item{ padding:8px; border:1px dashed #999; border-radius:8px; margin-bottom:8px; font-size:14px;}
  .out{ background:var(--panel); padding:12px; border-radius:10px; border:1px solid var(--border); line-height:1.5; font-size:15px;}
  .out h3{ margin:6px 0; font-size:16px;}
  .out ul{ margin:6px 0 10px 20px; padding:0;}
  .pill{ display:inline-block; padding:2px 8px; border-radius:999px; font-weight:600; font-size:12px; color:#000;}
  .pill.left{ background:var(--pickL); } .pill.right{ background:var(--pickR); } .pill.roll{ background:var(--roll); }
  .muted{ color:#444; font-size:13px;}
  #debug{ margin-top:6px; font-size:12px; color:#b00020; white-space:pre-wrap; border:1px dashed #ddd; padding:6px; border-radius:6px;}
  .topbar{ display:grid; grid-template-columns: 1fr; gap:10px;}
  .note{ font-size:12px; color:#555; }
</style>
</head>
<body>
<h1>Rigging CG Helper — v12 <span class="badge" id="badge">JS not ready</span></h1>

<!-- OUTPUT PANE FIRST (largest & easiest to spot) -->
<fieldset>
  <legend>Output (quick)</legend>
  <div id="summary" class="out">Add items and click “Compute + Draw”.</div>
  <div class="muted">Legend: <span class="pill left">Left pick</span> <span class="pill right">Right pick</span> <span class="pill roll">Roll</span></div>
</fieldset>

<!-- PICK / CHOKER PLACEMENT -->
<fieldset>
  <legend>Pick & Choker setup</legend>
  <div class="row3">
    <label>Pick mode
      <select id="pickMode">
        <option value="2">2 picks</option>
        <option value="4" selected>4 contacts (two inverted baskets)</option>
      </select>
    </label>
    <label>Choker placement
      <select id="chokerPlace">
        <option value="AUTO" selected>Auto (CG & span)</option>
        <option value="MANUAL">Manual (enter spacing/spread)</option>
      </select>
    </label>
    <label>Pick axis (for AUTO)
      <select id="pickAxis">
        <option value="AUTO" selected>Auto: use largest span</option>
        <option value="X">X (left → right)</option>
        <option value="Y">Y (toward / away)</option>
        <option value="Z">Z (up / down)</option>
      </select>
    </label>
  </div>
  <div class="row" id="manualRow" style="display:none">
    <label>Pick spacing (center-to-center, in)
      <input id="pickSpacing" type="number" inputmode="decimal" value="72">
    </label>
    <label>Basket spread per side (contact-to-center, in)
      <input id="basketSpread" type="number" inputmode="decimal" value="12">
    </label>
  </div>
  <div class="row">
    <label>No-roll torque threshold (ft-lb, optional)
      <input id="rollThresh" type="number" inputmode="decimal" placeholder="">
    </label>
    <label>Pipe OD (for roll calc)
      <input id="pipeOD" type="number" inputmode="decimal" value="24">
    </label>
  </div>
  <div class="note">XYZ directions (used throughout UI): X+: left → right, X−: right → left · Y+: toward, Y−: away · Z+: up, Z−: down.</div>
</fieldset>

<!-- ADD ITEMS -->
<fieldset>
  <legend>Add item</legend>
  <div class="row">
    <label>Item type
      <select id="itemType">
        <option value="P">24" pipe (per-inch)</option>
        <option value="V">24" valve (regular)</option>
        <option value="I">24" valve inline</option>
        <option value="C">24" coupling (weight only)</option>
        <option value="E">24" 90° elbow</option>
        <option value="F">24" 45° elbow</option>
        <option value="T">24" tee (plain)</option>
        <option value="W">24" tee with valve</option>
        <option value="G">Single 90 with valve</option>
        <option value="X">Custom per-inch</option>
        <option value="Y">Custom fixed</option>
      </select>
    </label>
    <label>Orientation (axis + direction)
      <select id="orient">
        <option value="A" selected>A — X+ (left → right)</option>
        <option value="B">B — X− (right → left)</option>
        <option value="C">C — Y+ (toward)</option>
        <option value="D">D — Y− (away)</option>
        <option value="E">E — Z+ (up)</option>
        <option value="F">F — Z− (down)</option>
      </select>
    </label>
  </div>

  <!-- dynamic detail row switches per type -->
  <div class="row" id="lenRow" style="display:block">
    <label>Length (in)
      <input id="lenIn" type="number" inputmode="decimal" value="60">
    </label>
    <label id="wpiLabel">Weight per inch (lb/in)
      <input id="wpi" type="number" inputmode="decimal" value="8.2">
    </label>
  </div>

  <div class="row" id="fixedRow" style="display:none">
    <label>Total weight (lb)
      <input id="fixedW" type="number" inputmode="decimal" value="0">
    </label>
    <label>Effective length along chosen axis (in)
      <input id="fixedL" type="number" inputmode="decimal" value="0">
    </label>
  </div>

  <div id="single90Row" class="row" style="display:none">
    <label>Straight before 90 (in)
      <input id="s90_before" type="number" inputmode="decimal" value="0">
    </label>
    <label>Extra straight AFTER 90 (in)
      <input id="s90_after" type="number" inputmode="decimal" value="0">
    </label>
    <label>Valve type
      <select id="s90_vtype">
        <option value="S">Standard</option>
        <option value="I">Inline</option>
      </select>
    </label>
  </div>

  <button class="btn" id="addBtn" type="button">Add item</button>
  <button class="btn secondary" id="clearBtn" type="button">Clear list</button>

  <div class="items" id="items"></div>
  <div id="debug">debug: (none)</div>
</fieldset>

<div class="topbar">
  <button class="btn" id="computeBtn" type="button">Compute + Draw</button>
  <button class="btn secondary" id="downloadBtn" type="button" disabled>Download PNG</button>
</div>

<!-- DRAWINGS -->
<fieldset>
  <legend>Drawings</legend>
  <canvas id="sheet"></canvas>
  <div class="muted">Plan (X–Y) and Elevation (X–Z). Arrowheads mark pick/contacts on the chosen pick axis’ zero line.</div>
</fieldset>

<script>
(function(){ var b=document.getElementById('badge'); if(b) b.textContent='Ready v12'; })();

/* HiDPI canvas */
function setupCanvas(canvas, cssW, cssH){
  cssW=cssW||1000; cssH=cssH||1200;
  var dpr=window.devicePixelRatio||1;
  canvas.style.width=cssW+'px'; canvas.style.height=cssH+'px';
  canvas.width=Math.floor(cssW*dpr); canvas.height=Math.floor(cssH*dpr);
  var ctx=canvas.getContext('2d'); ctx.setTransform(dpr,0,0,dpr,0,0); ctx.textBaseline='top'; return ctx;
}

/* Constants (24" system) */
var PIPE_DIAM_IN=24.0, PIPE_R_IN=PIPE_DIAM_IN/2.0;
var W_PER_IN_DEFAULT=8.2;
var W_EL90=475.0, S_EL90=36.0; // 90
var W_EL45=240.0, S_EL45=15.0; // 45
var W_COUP=115.0;
var W_VALVE_BODY=451.0, L_VALVE_STD=12.0;
var W_VALVE_INLINE=631.0, L_VALVE_INLINE=12.0;
var W_TEE_BODY=477.0, L_TEE=20.0;

var DEFAULT_PICK_SPACING=72.0;      // manual
var DEFAULT_BASKET_SPREAD=12.0;     // manual

/* Colors */
var COLORS={
  axisX:'#d12222', axisY:'#2a9d2a', axisZ:'#1f6feb',
  P:'#666666', E:'#2aa198', F:'#2aa198', V:'#ff9100', I:'#ff9100', C:'#8e44ad', T:'#d33682', W:'#d33682', G:'#2aa198', X:'#8d6e63', Y:'#8d6e63',
  pickLeft:(getComputedStyle(document.documentElement).getPropertyValue('--pickL')||'#ffd60a').trim(),
  pickRight:(getComputedStyle(document.documentElement).getPropertyValue('--pickR')||'#32cd32').trim(),
  pipeBand:'rgba(100,100,100,0.18)', centerline:'#000'
};

/* Helpers */
var ORIENTS={ A:[ 1,0,0], B:[-1,0,0], C:[ 0,1,0], D:[ 0,-1,0], E:[ 0,0,1], F:[ 0,0,-1] };
function r4(x){ return Math.round(x*4)/4; }
function r8(x){ return Math.round(x*8)/8; }
function fmtFtIn(x){
  var v=r4(x), ft=Math.floor(v/12), rem=v-ft*12;
  var whole=Math.floor(rem), frac=Math.round((rem-whole)*100)/100;
  var map={"0":"", "0.25":"-1/4", "0.5":"-1/2", "0.75":"-3/4"};
  var tag = (map.hasOwnProperty(String(frac))?map[String(frac)]:null);
  var inch = (tag!==null)? (whole+tag+'"') : (rem.toFixed(2)+'"');
  return ft? (ft+"' "+inch) : inch;
}
function fmtEighthIn(x){
  var v=r8(x), whole=Math.floor(v), frac=v-whole;
  var fr={"0":"", "0.125":" 1/8","0.25":" 1/4","0.375":" 3/8","0.5":" 1/2","0.625":" 5/8","0.75":" 3/4","0.875":" 7/8"};
  if(fr.hasOwnProperty(String(frac))){
    if(whole) return whole+fr[String(frac)]+'"';
    return fr[String(frac)]?fr[String(frac)].trim()+'"':'0"';
  }
  return v.toFixed(3)+'"';
}
function rollAngleDegForY(y_cg,R){ R=(typeof R==='number'?R:PIPE_R_IN); var y=Math.max(-R,Math.min(R,y_cg)); return R>0?(Math.asin(y/R)*180/Math.PI):0; }

/* State */
var items=[], segments=[], marks=[];

/* UI refs */
function el(id){ return document.getElementById(id); }
var pickModeEl, chokerPlaceEl, pickAxisEl, pickSpacingEl, basketSpreadEl, manualRow, rollThreshEl, pipeODEl;
var itemTypeEl, orientEl, lenRow, wpiEl, wpiLabel, lenInEl, fixedRow, fixedWEl, fixedLEl, single90Row, s90_beforeEl, s90_afterEl, s90_vtypeEl;
var itemsDiv, summaryDiv, sheet, debugDiv, ctx;

/* Setup */
window.onload=function(){
  pickModeEl=el('pickMode'); chokerPlaceEl=el('chokerPlace'); pickAxisEl=el('pickAxis');
  pickSpacingEl=el('pickSpacing'); basketSpreadEl=el('basketSpread'); manualRow=el('manualRow'); rollThreshEl=el('rollThresh'); pipeODEl=el('pipeOD');

  itemTypeEl=el('itemType'); orientEl=el('orient'); lenRow=el('lenRow'); wpiEl=el('wpi'); wpiLabel=el('wpiLabel'); lenInEl=el('lenIn');
  fixedRow=el('fixedRow'); fixedWEl=el('fixedW'); fixedLEl=el('fixedL');
  single90Row=el('single90Row'); s90_beforeEl=el('s90_before'); s90_afterEl=el('s90_after'); s90_vtypeEl=el('s90_vtype');

  itemsDiv=el('items'); summaryDiv=el('summary'); sheet=el('sheet'); debugDiv=el('debug');
  ctx=setupCanvas(sheet);

  pickModeEl.addEventListener('change', syncManualVisibility);
  chokerPlaceEl.addEventListener('change', syncManualVisibility);
  syncManualVisibility();

  itemTypeEl.addEventListener('change', updateDetailRows);
  updateDetailRows();

  el('addBtn').addEventListener('click', addItem);
  el('clearBtn').addEventListener('click', resetAll);
  el('computeBtn').addEventListener('click', computeAndDraw);
  el('downloadBtn').addEventListener('click', function(){
    var a=document.createElement('a'); var ts=new Date().toISOString().slice(0,19).replace(/[:T]/g,'-');
    a.download=ts+'_rigging.png'; a.href=sheet.toDataURL('image/png'); a.click();
  });

  if(debugDiv) debugDiv.textContent='debug: ready (v12)';
};

function syncManualVisibility(){
  manualRow.style.display = (chokerPlaceEl.value==='MANUAL' ? 'grid' : 'none');
}

/* Item management */
function updateDetailRows(){
  var t=itemTypeEl.value;
  lenRow.style.display='none'; fixedRow.style.display='none'; single90Row.style.display='none';
  if(t==='P'||t==='X'){ lenRow.style.display='grid'; wpiLabel.style.display='block'; }
  if(t==='Y'){ fixedRow.style.display='grid'; }
  if(t==='G'){ single90Row.style.display='grid'; }
  if(t!=='X') wpiEl.value=W_PER_IN_DEFAULT;
}

function addItemSummary(text){
  var d=document.createElement('div'); d.className='item'; d.textContent=text; itemsDiv.appendChild(d);
}

function resetAll(){
  items=[]; segments=[]; marks=[];
  itemsDiv.innerHTML=''; summaryDiv.innerHTML='Add items and click “Compute + Draw”.';
  ctx.clearRect(0,0,sheet.width,sheet.height);
  if(debugDiv) debugDiv.textContent='debug: reset';
}

function getCurrentEnd(){ return segments.length===0?[0,0,0]:segments[segments.length-1].end.slice(); }

function pushSegment(tCode,dir,L,labelIdx){
  var start=getCurrentEnd(); var end=[ start[0]+dir[0]*L, start[1]+dir[1]*L, start[2]+dir[2]*L ];
  segments.push({tCode:tCode,start:start,end:end});
  var mid=[(start[0]+end[0])/2,(start[1]+end[1])/2,(start[2]+end[2])/2];
  marks.push([labelIdx,mid[0],mid[1],mid[2]]);
}

function addItem(){
  try{
    var t=itemTypeEl.value; var idx=items.length+1; var d=ORIENTS[orientEl.value]||[1,0,0];
    var dx=d[0], dy=d[1], dz=d[2];

    function placeLinear(name,L,W,xcgLocal,tCode){
      L=Math.max(0, Number(L)||0);
      var Lx = Math.abs(dx)*L + Math.abs(dy)*0 + Math.abs(dz)*0; // length contribution along X path for legacy display
      if(xcgLocal==null) xcgLocal=L/2;
      items.push({name:name,length:Lx,weight:W,xcg_local:(Math.abs(dx)>0?xcgLocal:0),tCode:tCode});
      pushSegment(tCode,[dx,dy,dz],L,idx);
    }

    if(t==='P'){
      var L=Number(lenInEl.value)||0, wpi=Number(wpiEl.value)||W_PER_IN_DEFAULT; var W=wpi*L;
      placeLinear('24" pipe (per-inch)',L,W,null,'P');
      addItemSummary(idx+'. Pipe '+L.toFixed(1)+' in @ '+wpi+' lb/in → '+W.toFixed(1)+' lb');

    }else if(t==='X'){
      var Lx=Number(lenInEl.value)||0, wpiX=Number(wpiEl.value)||W_PER_IN_DEFAULT; var WX=wpiX*Lx;
      placeLinear('Custom per-inch',Lx,WX,null,'X');
      addItemSummary(idx+'. Custom per-inch '+Lx.toFixed(1)+' in @ '+wpiX+' → '+WX.toFixed(1)+' lb');

    }else if(t==='Y'){
      var WY=Number(fixedWEl.value)||0, LY=Number(fixedLEl.value)||0;
      placeLinear('Custom fixed',LY,WY,null,'Y');
      addItemSummary(idx+'. Custom fixed '+WY.toFixed(1)+' lb, eff L='+LY.toFixed(1)+' in');

    }else if(t==='V'){
      var LV=L_VALVE_STD, WV=W_VALVE_BODY+W_COUP;
      var xcgV=(W_VALVE_BODY*(LV/2) + W_COUP*0)/WV;
      placeLinear('24" valve (regular)',LV,WV,xcgV,'V');
      addItemSummary(idx+'. Valve (regular) L='+LV+' in, W='+WV.toFixed(1)+' lb');

    }else if(t==='I'){
      var LI=L_VALVE_INLINE, WI=W_VALVE_INLINE;
      placeLinear('24" valve (inline)',LI,WI,LI/2,'I');
      addItemSummary(idx+'. Valve (inline) L='+LI+' in, W='+WI.toFixed(1)+' lb');

    }else if(t==='C'){
      items.push({name:'24" coupling',length:0,weight:W_COUP,xcg_local:0,tCode:'C'});
      pushSegment('C',[dx,dy,dz],1,idx); // 1 in stub for visibility
      addItemSummary(idx+'. Coupling W='+W_COUP.toFixed(1)+' lb');

    }else if(t==='E'){
      var LE=S_EL90, WE=W_EL90+W_COUP;
      var xcgE=(W_EL90*(LE/2)+W_COUP*0)/WE;
      placeLinear('24" 90° elbow',LE,WE,xcgE,'E');
      addItemSummary(idx+'. 90° elbow L='+LE+' in, W='+WE.toFixed(1)+' lb');

    }else if(t==='F'){
      var LF=S_EL45, WF=W_EL45+W_COUP;
      var xcgF=(W_EL45*(LF/2)+W_COUP*0)/WF;
      placeLinear('24" 45° elbow',LF,WF,xcgF,'F');
      addItemSummary(idx+'. 45° elbow L='+LF+' in, W='+WF.toFixed(1)+' lb');

    }else if(t==='T'){
      var LT=L_TEE, WT=W_TEE_BODY+W_COUP;
      var xcgT=(W_TEE_BODY*(LT/2)+W_COUP*0)/WT;
      placeLinear('24" tee (plain)',LT,WT,xcgT,'T');
      addItemSummary(idx+'. Tee (plain) L='+LT+' in, W='+WT.toFixed(1)+' lb');

    }else if(t==='W'){
      var LW=L_TEE;
      var parts=[[W_TEE_BODY,LW/2,0],[W_VALVE_BODY,LW/2,L_VALVE_STD/2],[W_COUP,0,0],[W_COUP,LW/2,0]];
      var WW=parts.reduce(function(a,p){return a+p[0];},0);
      var xcgW=parts.reduce(function(a,p){return a+p[0]*p[1];},0)/WW;
      placeLinear('24" tee with valve',LW,WW,xcgW,'W');
      addItemSummary(idx+'. Tee w/ valve L='+LW+' in, W='+WW.toFixed(1)+' lb');

    }else if(t==='G'){
      var Ls=Number(s90_beforeEl.value)||0, La=Number(s90_afterEl.value)||0, inline=(s90_vtypeEl.value==='I');
      var W1=W_PER_IN_DEFAULT*Ls, W2=W_EL90;
      var Wv= inline ? W_VALVE_INLINE : (W_VALVE_BODY + W_COUP);
      var Wafter=W_PER_IN_DEFAULT*La, Wt=W1+W2+Wv+Wafter;
      var x_span=Math.max(Ls, Ls+S_EL90, Ls+S_EL90);
      var xcgLocal = Math.min(x_span/2, Ls + S_EL90/2);
      placeLinear('Single 90 with valve',x_span,Wt,xcgLocal,'G');
      addItemSummary(idx+'. Single 90 + valve (Ls='+Ls+' in, La='+La+' in, '+(inline?'inline':'std')+') → W='+Wt.toFixed(1)+' lb');
    }

    if(debugDiv) debugDiv.textContent='debug: items='+items.length;
  }catch(err){
    if(debugDiv) debugDiv.textContent='debug: Add item failed: '+(err&&err.message?err.message:err);
  }
}

/* Math helpers */
function dist3(a,b){ var dx=b[0]-a[0], dy=b[1]-a[1], dz=b[2]-a[2]; return Math.sqrt(dx*dx+dy*dy+dz*dz); }
function addV(a,b){ return [a[0]+b[0],a[1]+b[1],a[2]+b[2]]; }
function mulV(a,k){ return [a[0]*k,a[1]*k,a[2]*k]; }

/* CG based on actual 3D marks + couplings at every joint */
function computeCG(){
  var totalW=0, sum=[0,0,0];
  for(var i=0;i<items.length;i++){
    var w=items[i].weight, p=[marks[i][1],marks[i][2],marks[i][3]];
    totalW+=w; sum=addV(sum, mulV(p,w));
  }
  for(var j=0;j<segments.length-1;j++){
    var end=segments[j].end; totalW+=W_COUP; sum=addV(sum, mulV(end,W_COUP));
  }
  return {CG: totalW>0? mulV(sum,1/totalW):[0,0,0], totalW: totalW};
}

/* Axis utilities */
function extentAlong(axisIndex){
  var arr=[]; for(var i=0;i<segments.length;i++){ arr.push(segments[i].start[axisIndex], segments[i].end[axisIndex]); }
  var mn=Math.min.apply(null,arr), mx=Math.max.apply(null,arr);
  return {min:mn, max:mx, span:mx-mn};
}
function chooseAxis(autoChoice){
  if(autoChoice!=='AUTO') return autoChoice;
  var exX=extentAlong(0), exY=extentAlong(1), exZ=extentAlong(2);
  var best='X', span=exX.span;
  if(exY.span>span){ best='Y'; span=exY.span; }
  if(exZ.span>span){ best='Z'; span=exZ.span; }
  return best;
}

/* Auto choker solver (axis-based, clamps inside geometry bounds) */
function solveChokersAuto(pickMode, pickAxisSel, CG){
  var axis=chooseAxis(pickAxisSel);
  var ax = (axis==='X'?0:(axis==='Y'?1:2));
  var ext=extentAlong(ax);

  // nominal spacing = 60% of span (clamped)
  var spacing = Math.max(24, 0.6*ext.span);
  var leftC = Math.max(ext.min, Math.min(ext.max-spacing, CG[ax]-spacing/2));
  var rightC = leftC + spacing;

  if(pickMode==='2') return {mode:'2', axis:axis, ext:ext, picks:[leftC, rightC]};

  // 4-contact: per-side spread = 15% of spacing (clamped to 6..48")
  var perSide = Math.max(6, Math.min(48, 0.15*spacing));
  var L1 = Math.max(ext.min, leftC - perSide/2);
  var L2 = Math.min(ext.max, leftC + perSide/2);
  var R1 = Math.max(ext.min, rightC - perSide/2);
  var R2 = Math.min(ext.max, rightC + perSide/2);
  // ensure order
  if(L1>L2){ var t=L1; L1=L2; L2=t; }
  if(R1>R2){ var t2=R1; R1=R2; R2=t2; }
  return {mode:'4', axis:axis, ext:ext, picks:[L1,L2,R1,R2], basket_spread:perSide};
}

/* Manual choker */
function solveChokersManual(pickMode, pickSpacing, basketSpread, CG){
  var axis='X', ext=extentAlong(0); // manual placement is along X as a baseline
  var spacing=Math.max(0, pickSpacing||DEFAULT_PICK_SPACING);
  var leftC=Math.max(ext.min, Math.min(ext.max-spacing, CG[0]-spacing/2));
  var rightC=leftC+spacing;
  if(pickMode==='2') return {mode:'2', axis:axis, ext:ext, picks:[leftC,rightC]};
  var s=Math.max(0, basketSpread||DEFAULT_BASKET_SPREAD);
  var L1=Math.max(ext.min, leftC - s/2), L2=Math.min(ext.max, leftC + s/2);
  var R1=Math.max(ext.min, rightC - s/2), R2=Math.min(ext.max, rightC + s/2);
  return {mode:'4', axis:axis, ext:ext, picks:[L1,L2,R1,R2], basket_spread:s};
}

/* Compute & draw */
function computeAndDraw(){
  if(items.length===0){ alert('Add at least one item.'); return; }

  var pipeOD = Number(pipeODEl.value)||24; var R = pipeOD/2;
  var cgInfo = computeCG(); var CG=cgInfo.CG; var totalW=cgInfo.totalW;

  // roll
  var roll_deg = rollAngleDegForY(CG[1], R);
  var roll_side = CG[1]>0 ? 'toward +Y' : (CG[1]<0 ? 'toward -Y' : 'no roll needed');
  var arc_in = R * (Math.abs(roll_deg)*Math.PI/180);
  var arc_in_str = fmtEighthIn(arc_in);

  // choker placement
  var pickMode = el('pickMode').value;
  var placementMode = el('chokerPlace').value;
  var picksInfo = (placementMode==='AUTO')
        ? solveChokersAuto(pickMode, el('pickAxis').value, CG)
        : solveChokersManual(pickMode, Number(el('pickSpacing').value), Number(el('basketSpread').value), CG);

  // summary HTML (Left Edge = min edge of chosen axis)
  var axisName=picksInfo.axis;
  var minEdge = picksInfo.ext.min;
  var html='';
  html += '<h3>Rigging Summary</h3><ul>';
  html += '<li>Total weight: <b>'+totalW.toFixed(1)+' lb</b></li>';
  html += '<li>CG: X=<b>'+CG[0].toFixed(2)+'</b> in, Y=<b>'+CG[1].toFixed(2)+'</b> in, Z=<b>'+CG[2].toFixed(2)+'</b> in</li>';
  html += '<li>Pick axis: <b>'+axisName+'</b> (Left Edge = min '+axisName+')</li>';
  html += '</ul>';

  html += '<h3>Pick Points (from Left Edge on '+axisName+')</h3><ul>';
  if(picksInfo.mode==='2'){
    html += '<li><span class="pill left">Left pick</span> '+fmtFtIn(picksInfo.picks[0]-minEdge)+'</li>';
    html += '<li><span class="pill right">Right pick</span> '+fmtFtIn(picksInfo.picks[1]-minEdge)+'</li>';
    html += '<li>Pick spacing: '+fmtFtIn(picksInfo.picks[1]-picksInfo.picks[0])+'</li>';
  }else{
    var P=picksInfo.picks;
    html += '<li><span class="pill left">Left basket</span> L- '+fmtFtIn(P[0]-minEdge)+', L+ '+fmtFtIn(P[1]-minEdge)+'</li>';
    html += '<li><span class="pill right">Right basket</span> R- '+fmtFtIn(P[2]-minEdge)+', R+ '+fmtFtIn(P[3]-minEdge)+'</li>';
    if(picksInfo.basket_spread!=null) html += '<li>Per-side spread: '+fmtFtIn(picksInfo.basket_spread)+'</li>';
  }
  html += '</ul>';

  html += '<h3>Roll</h3><ul>';
  html += '<li><span class="pill roll">Roll</span> chokers: ~'+roll_deg.toFixed(1)+'° '+roll_side+'</li>';
  html += '<li><span class="pill roll">Roll</span> circumference offset per choker: '+arc_in_str+'</li>';
  var rollThresh=(el('rollThresh').value===''? null : Math.max(0, Number(el('rollThresh').value)));
  if(rollThresh!==null) html += '<li>No-roll torque threshold (ft-lb): '+Math.round(rollThresh)+'</li>';
  html += '</ul>';

  summaryDiv.innerHTML = html;

  // draw
  drawSheet(picksInfo);
  el('downloadBtn').disabled=false;
}

/* Drawing */
function drawSheet(picksInfo){
  ctx=setupCanvas(sheet, 1000, 1200);
  var W=1000,H=1200,pad=28, secH=Math.floor((H-pad*4)/2);
  var planRect={x:pad,y:pad,w:W-2*pad,h:secH};
  var elevRect={x:pad,y:pad*2+secH,w:W-2*pad,h:secH};

  ctx.fillStyle='#fff'; ctx.fillRect(0,0,W,H);

  var verts=[[0,0,0]];
  for(var i=0;i<segments.length;i++){ verts.push(segments[i].end.slice()); }
  var px=verts.map(v=>v[0]), py=verts.map(v=>v[1]), pz=verts.map(v=>v[2]);

  drawProjection(planRect, px, py, 'Plan (X–Y)', picksInfo, 'XY');
  drawProjection(elevRect, px, pz, 'Elevation (X–Z)', picksInfo, 'XZ');
}

function drawProjection(rect, px, py, title, picksInfo, plane){
  var minX=Math.min.apply(null, px.concat([0])), maxX=Math.max.apply(null, px.concat([1]));
  var minY=Math.min.apply(null, py.concat([-1])), maxY=Math.max.apply(null, py.concat([1]));

  var pad=46, sx=(rect.w-pad*2)/((maxX-minX)||1), sy=(rect.h-pad*2)/((maxY-minY)||1), s=Math.min(sx,sy);
  function mapX(x){ return rect.x+pad+(x-minX)*s; }
  function mapY(y){ return rect.y+rect.h-pad-(y-minY)*s; }

  ctx.fillStyle='#000'; ctx.font='20px system-ui'; ctx.fillText(title, rect.x, rect.y-6);

  // axes
  ctx.lineWidth=2;
  ctx.strokeStyle=COLORS.axisX; ctx.beginPath(); ctx.moveTo(mapX(minX), mapY(0)); ctx.lineTo(mapX(maxX), mapY(0)); ctx.stroke();
  ctx.strokeStyle=(plane==='XY')?COLORS.axisY:COLORS.axisZ; var x0=mapX(0);
  ctx.beginPath(); ctx.moveTo(x0, mapY(minY)); ctx.lineTo(x0, mapY(maxY)); ctx.stroke();

  // pipe thickness band & centerlines
  var thickness=Math.min(30, Math.max(8, s*24*0.6)); ctx.lineCap='round';
  for(var i=0;i<segments.length;i++){
    var seg=segments[i];
    var sx0=mapX(seg.start[0]), sy0=mapY(plane==='XY'?seg.start[1]:seg.start[2]);
    var sx1=mapX(seg.end[0]),   sy1=mapY(plane==='XY'?seg.end[1]:seg.end[2]);
    ctx.strokeStyle=COLORS.pipeBand; ctx.lineWidth=thickness; ctx.beginPath(); ctx.moveTo(sx0,sy0); ctx.lineTo(sx1,sy1); ctx.stroke();
  }
  for(var j=0;j<segments.length;j++){
    var seg2=segments[j];
    var sx02=mapX(seg2.start[0]), sy02=mapY(plane==='XY'?seg2.start[1]:seg2.start[2]);
    var sx12=mapX(seg2.end[0]),   sy12=mapY(plane==='XY'?seg2.end[1]:seg2.end[2]);
    ctx.strokeStyle=COLORS[seg2.tCode]||COLORS.centerline; ctx.lineWidth=3; ctx.beginPath(); ctx.moveTo(sx02,sy02); ctx.lineTo(sx12,sy12); ctx.stroke();
  }

  // labels
  ctx.fillStyle='#000'; ctx.font='14px system-ui';
  for(var m=0;m<marks.length;m++){
    var mk=marks[m]; var x=mk[1], y=(plane==='XY'? mk[2] : mk[3]);
    ctx.fillText(String(mk[0]), mapX(x)+4, mapY(y)-16);
  }

  // choker markers on chosen axis zero line for visual reference
  var zeroY = (picksInfo.axis==='X') ? 0 : (plane==='XY' ? (picksInfo.axis==='Y'?0:NaN) : (picksInfo.axis==='Z'?0:NaN));
  var showAxisLine = !Number.isNaN(zeroY);

  // top caption pills
  var topY=rect.y+10;
  if(picksInfo.mode==='2'){
    var xl=picksInfo.picks[0], xr=picksInfo.picks[1];
    drawTopPill(rect.x+12,topY-8,130,22,COLORS.pickLeft,'Left pick');
    drawTopPill(rect.x+152,topY-8,140,22,COLORS.pickRight,'Right pick');
    if(showAxisLine){
      drawLeader(rect.x+77,topY+10,mapX(xl),mapY(zeroY),(COLORS.pickLeft));
      drawLeader(rect.x+222,topY+10,mapX(xr),mapY(zeroY),(COLORS.pickRight));
      drawPickMarker(mapX(xl),mapY(zeroY),COLORS.pickLeft,'L');
      drawPickMarker(mapX(xr),mapY(zeroY),COLORS.pickRight,'R');
    }
  }else{
    var P=picksInfo.picks, L1=P[0], L2=P[1], R1=P[2], R2=P[3];
    drawTopPill(rect.x+12,topY-8,160,22,COLORS.pickLeft,'Left basket');
    drawTopPill(rect.x+184,topY-8,170,22,COLORS.pickRight,'Right basket');
    if(showAxisLine){
      drawLeader(rect.x+92,topY+10,mapX((L1+L2)/2),mapY(zeroY),COLORS.pickLeft);
      drawLeader(rect.x+270,topY+10,mapX((R1+R2)/2),mapY(zeroY),COLORS.pickRight);
      [[L1,'L-'],[L2,'L+'],[R1,'R-'],[R2,'R+']].forEach(function(pair,i){
        var x=pair[0], label=pair[1];
        drawPickMarker(mapX(x),mapY(zeroY),(i<2?COLORS.pickLeft:COLORS.pickRight),label);
      });
    }
  }

  ctx.strokeStyle='#cfd4d9'; ctx.lineWidth=1; ctx.strokeRect(rect.x,rect.y,rect.w,rect.h);

  // helpers
  function drawTopPill(x,y,w,h,color,label){
    ctx.fillStyle=color; ctx.strokeStyle=color; var r=h/2;
    ctx.beginPath(); ctx.moveTo(x+r,y); ctx.lineTo(x+w-r,y);
    ctx.arc(x+w-r,y+r,r,-Math.PI/2,Math.PI/2);
    ctx.lineTo(x+r,y+h); ctx.arc(x+r,y+r,r,Math.PI/2,Math.PI*1.5);
    ctx.closePath(); ctx.fill(); ctx.fillStyle='#000'; ctx.font='13px system-ui'; ctx.fillText(label,x+8,y+4);
  }
  function drawLeader(x1,y1,x2,y2,color){
    ctx.strokeStyle=color; ctx.lineWidth=2; ctx.beginPath(); ctx.moveTo(x1,y1); ctx.lineTo(x2,y2); ctx.stroke();
  }
  function drawPickMarker(x,y,color,label){
    ctx.strokeStyle=color; ctx.fillStyle=color;
    ctx.beginPath(); ctx.moveTo(x,y-16); ctx.lineTo(x,y-2); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(x,y-2); ctx.lineTo(x-6,y-10); ctx.moveTo(x,y-2); ctx.lineTo(x+6,y-10); ctx.stroke();
    ctx.beginPath(); ctx.arc(x,y,4,0,Math.PI*2); ctx.fill();
    ctx.fillStyle='#000'; ctx.font='12px system-ui'; ctx.fillText(label,x+6,y-18);
  }
}
</script>
</body>
</html>
