<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>Rigging CG Helper — v11 (Auto Hook & Pulley, 4-Point Baskets)</title>
<style>
  :root{
    --bg:#ffffff; --ink:#111; --panel:#f6f8fa; --border:#e9ecef; --accent:#0d6efd;
    --roll:#5bc0ff; --pickA:#ffd60a; --pickB:#32cd32;
  }
  body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin:16px; color:var(--ink); background:var(--bg); }
  h1 { font-size:20px; margin:0 0 10px; display:flex; align-items:center; gap:10px;}
  .badge{display:inline-block; padding:2px 8px; border-radius:999px; background:#d1e7dd; color:#0f5132; font-weight:700; font-size:12px;}
  fieldset { border:1px solid #ccc; border-radius:10px; margin:10px 0; padding:10px 12px; }
  legend { padding:0 6px; font-weight:600; }
  label { display:block; margin:6px 0 2px; font-size:14px; }
  select, input[type="number"], input[type="text"] { width:100%; font-size:16px; padding:10px 12px; box-sizing:border-box; border-radius:8px; border:1px solid #cfd4d9; }
  .row { display:grid; grid-template-columns:1fr 1fr; gap:10px; }
  .row3{ display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px; }
  .btn { display:inline-block; padding:10px 12px; margin:8px 6px 0 0; border-radius:10px; background:var(--accent); color:#fff; border:none; font-size:16px; cursor:pointer;}
  .btn.secondary{ background:#6c757d; }
  #sheet{ width:100%; max-width:1000px; background:#fff; border:1px solid #ddd; border-radius:8px; display:block;}
  .items{ margin-top:6px;}
  .item{ padding:8px; border:1px dashed #999; border-radius:8px; margin-bottom:8px; font-size:14px;}
  .out{ background:var(--panel); padding:12px; border-radius:10px; border:1px solid var(--border); line-height:1.5; font-size:15px;}
  .out h3{ margin:6px 0; font-size:16px;}
  .out ul{ margin:6px 0 10px 20px; padding:0;}
  .pill{ display:inline-block; padding:2px 8px; border-radius:999px; font-weight:600; font-size:12px; color:#000;}
  .pill.A{ background:var(--pickA); } .pill.B{ background:var(--pickB); }
  .muted{ color:#444; font-size:13px;}
  #debug{ margin-top:6px; font-size:12px; color:#b00020; white-space:pre-wrap; border:1px dashed #ddd; padding:6px; border-radius:6px;}
  .contact-grid{ display:grid; grid-template-columns:1.2fr 0.8fr; gap:8px; }
  .contact-card{ border:1px solid #ddd; border-radius:10px; padding:10px; margin-top:8px; background:#fff; }
  .contact-card h4{ margin:0 0 6px; font-size:14px;}
  .allow-grid{ display:grid; grid-template-columns:1fr 1fr 1fr; gap:8px;}
  .small{ font-size:12px; color:#666;}
</style>
</head>
<body>
<h1>Rigging CG Helper — v11 <span class="badge" id="badge">JS not ready</span></h1>

<fieldset>
  <legend>Pick system</legend>
  <div class="row3">
    <label>Mode
      <select id="mode">
        <option value="2">2-Pick (simple)</option>
        <option value="4b" selected>4-Point (Pulley + Inverted Baskets)</option>
      </select>
    </label>
    <label>Pick spacing (2-pick only, in)
      <input id="pickSpacing" type="number" inputmode="decimal" value="72">
    </label>
    <label>Auto axes
      <select id="axes">
        <option value="AUTO" selected>Auto (by span)</option>
        <option value="X">X only (left → right)</option>
        <option value="Y">Y only (toward / away)</option>
        <option value="Z">Z only (up / down)</option>
      </select>
    </label>
  </div>
  <div class="allow-grid">
    <label>Pipe OD (in)
      <input id="pipeOD" type="number" inputmode="decimal" value="24">
    </label>
    <label>Sheave D (in)
      <input id="sheaveD" type="number" inputmode="decimal" value="12">
    </label>
    <label>Top hardware allowance per side (in)
      <input id="allowTop" type="number" inputmode="decimal" value="6">
    </label>
  </div>
  <div class="allow-grid">
    <label>Loop wrap allowance (per basket, in)
      <input id="allowLoop" type="number" inputmode="decimal" value="24">
    </label>
    <label>Top choker length (ft)
      <input id="lenTopFt" type="number" inputmode="decimal" value="20">
    </label>
    <label>Basket loop length (ft)
      <input id="lenLoopFt" type="number" inputmode="decimal" value="20">
    </label>
  </div>
  <div class="small">Y+: toward, Y−: away. Hook & pulley heights are solved automatically from the fixed 20′ lengths and allowances.</div>
</fieldset>

<fieldset>
  <legend>Add item</legend>
  <div class="row">
    <label>Item type
      <select id="itemType">
        <option value="P">24&quot; pipe (per-inch)</option>
        <option value="V">24&quot; valve (regular)</option>
        <option value="I">24&quot; valve inline</option>
        <option value="E">24&quot; 90° elbow</option>
        <option value="F">24&quot; 45° elbow</option>
        <option value="T">24&quot; tee (plain)</option>
        <option value="W">24&quot; tee with valve</option>
        <option value="X">Custom per-inch</option>
        <option value="Y">Custom fixed</option>
      </select>
    </label>
    <label>Orientation (A=X+, B=X−, C=Y+, D=Y−, E=Z+, F=Z−)
      <select id="orient">
        <option value="A" selected>A (X+)</option>
        <option value="B">B (X−)</option>
        <option value="C">C (Y+)</option>
        <option value="D">D (Y−)</option>
        <option value="E">E (Z+)</option>
        <option value="F">F (Z−)</option>
      </select>
    </label>
  </div>
  <div class="row" id="lenRow" style="display:block">
    <label>Length (in)
      <input id="lenIn" type="number" inputmode="decimal" value="60">
    </label>
    <label id="wpiLabel">Weight per inch (lb/in)
      <input id="wpi" type="number" inputmode="decimal" value="8.2">
    </label>
  </div>
  <div class="row" id="fixedRow" style="display:none">
    <label>Total weight (lb)
      <input id="fixedW" type="number" inputmode="decimal" value="0">
    </label>
    <label>Effective length along chosen axis (in)
      <input id="fixedL" type="number" inputmode="decimal" value="0">
    </label>
  </div>
  <div id="single90Row" class="row" style="display:none">
    <label>Straight before 90 (in)
      <input id="s90_before" type="number" inputmode="decimal" value="0">
    </label>
    <label>Extra straight AFTER 90 (in)
      <input id="s90_after" type="number" inputmode="decimal" value="0">
    </label>
    <label>Valve type
      <select id="s90_vtype">
        <option value="S">Standard</option>
        <option value="I">Inline</option>
      </select>
    </label>
  </div>
  <button class="btn" id="addBtn" type="button">Add item</button>
  <button class="btn secondary" id="clearBtn" type="button">Clear list</button>
  <div class="items" id="items"></div>
  <div id="debug">debug: (none)</div>
</fieldset>

<fieldset>
  <legend>4-Point Contacts (Pulley A & B)</legend>
  <div class="row">
    <div class="contact-card">
      <h4><span class="pill A">Pulley A</span> contacts</h4>
      <div class="contact-grid">
        <label>A-L segment
          <select id="AL_seg"></select>
        </label>
        <label>A-L offset (in)
          <input id="AL_off" type="number" inputmode="decimal" value="0">
        </label>
        <label>A-R segment
          <select id="AR_seg"></select>
        </label>
        <label>A-R offset (in)
          <input id="AR_off" type="number" inputmode="decimal" value="0">
        </label>
      </div>
    </div>
    <div class="contact-card">
      <h4><span class="pill B">Pulley B</span> contacts</h4>
      <div class="contact-grid">
        <label>B-L segment
          <select id="BL_seg"></select>
        </label>
        <label>B-L offset (in)
          <input id="BL_off" type="number" inputmode="decimal" value="0">
        </label>
        <label>B-R segment
          <select id="BR_seg"></select>
        </label>
        <label>B-R offset (in)
          <input id="BR_off" type="number" inputmode="decimal" value="0">
        </label>
      </div>
    </div>
  </div>
  <div class="small">Pick any four points on the geometry. Offsets are measured from each segment’s start face.</div>
</fieldset>

<button class="btn" id="computeBtn" type="button">Compute + Draw</button>
<button class="btn secondary" id="downloadBtn" type="button" disabled>Download PNG</button>

<fieldset>
  <legend>Output (quick)</legend>
  <div id="summary" class="out"></div>
  <div class="muted">Legend: <span class="pill A">Pulley A</span> (A-L, A-R), <span class="pill B">Pulley B</span> (B-L, B-R)</div>
</fieldset>

<fieldset>
  <legend>Drawings</legend>
  <canvas id="sheet"></canvas>
  <div class="muted">Plan (X–Y) and Elevation (X–Z). Lines touch pipe at exact contact points; pulleys and top chokers are solved from 20′ lengths.</div>
</fieldset>

<script>
(function(){ var b=document.getElementById('badge'); if(b) b.textContent='JS Loaded v11'; })();

if(!window.__rig_v11_wired){
  window.__rig_v11_wired = true;

  function el(id){ return document.getElementById(id); }
  function setupCanvas(canvas, cssW, cssH){
    cssW=cssW||1000; cssH=cssH||1200;
    var dpr=window.devicePixelRatio||1;
    canvas.style.width=cssW+'px'; canvas.style.height=cssH+'px';
    canvas.width=Math.floor(cssW*dpr); canvas.height=Math.floor(cssH*dpr);
    var ctx=canvas.getContext('2d'); ctx.setTransform(dpr,0,0,dpr,0,0); ctx.textBaseline='top'; return ctx;
  }

  /* Constants */
  var W_PER_IN_DEFAULT=8.2, PIPE_OD_DEFAULT=24.0;
  var W_EL90=475.0, S_EL90=36.0, W_EL45=240.0, S_EL45=15.0;
  var W_TEE_BODY=477.0, L_TEE=20.0;
  var W_VALVE_BODY=451.0, L_VALVE_STD=12.0, W_VALVE_INLINE=631.0, L_VALVE_INLINE=12.0;
  var W_COUP=115.0;

  var COLORS={ axisX:'#d12222', axisY:'#2a9d2a', axisZ:'#1f6feb',
    P:'#666', E:'#2aa198', F:'#2aa198', V:'#ff9100', I:'#ff9100', C:'#8e44ad', T:'#d33682', W:'#d33682', X:'#8d6e63', Y:'#8d6e63',
    A:(getComputedStyle(document.documentElement).getPropertyValue('--pickA')||'#ffd60a').trim(),
    B:(getComputedStyle(document.documentElement).getPropertyValue('--pickB')||'#32cd32').trim(),
    pipeBand:'rgba(100,100,100,0.18)', centerline:'#000' };

  var ORIENTS={A:[1,0,0],B:[-1,0,0],C:[0,1,0],D:[0,-1,0],E:[0,0,1],F:[0,0,-1]};

  /* State */
  var items=[], segments=[], marks=[];
  var ctx, sheet=el('sheet'), debugDiv=el('debug'), summaryDiv=el('summary');
  ctx=setupCanvas(sheet);

  function r4(x){return Math.round(x*4)/4;}
  function r8(x){return Math.round(x*8)/8;}
  function fmtFtIn(x){ var v=r4(x), ft=Math.floor(v/12), rem=v-ft*12; var whole=Math.floor(rem), frac=Math.round((rem-whole)*100)/100;
    var map={"0":"","0.25":"-1/4","0.5":"-1/2","0.75":"-3/4"}; var tag=map.hasOwnProperty(String(frac))?map[String(frac)]:null;
    var inch=tag!==null? (whole+tag+'"') : (rem.toFixed(2)+'"'); return ft? (ft+"' "+inch):inch; }
  function fmtIn(x){ return r8(x).toFixed(3).replace(/\.000$/,'')+'"'; }

  function resetAll(){
    items=[]; segments=[]; marks=[];
    el('items').innerHTML=''; summaryDiv.innerHTML='';
    ctx.clearRect(0,0,sheet.width,sheet.height);
    if(debugDiv) debugDiv.textContent='debug: reset';
    populateContactDropdowns();
  }

  function addItemSummary(text){ var d=document.createElement('div'); d.className='item'; d.textContent=text; el('items').appendChild(d); }
  function getEnd(){ return segments.length===0?[0,0,0]:segments[segments.length-1].end.slice(); }
  function pushSeg(tCode, dir, L, labelIdx){
    var s=getEnd(), e=[s[0]+dir[0]*L, s[1]+dir[1]*L, s[2]+dir[2]*L];
    segments.push({tCode:tCode,start:s,end:e});
    var mid=[(s[0]+e[0])/2,(s[1]+e[1])/2,(s[2]+e[2])/2];
    marks.push([labelIdx,mid[0],mid[1],mid[2]]);
  }

  function addItem(){
    try{
      var t=el('itemType').value, idx=items.length+1, d=ORIENTS[el('orient').value]||[1,0,0];
      function placeLinear(name,L,W,xcg,tCode){
        L=Math.max(0, Number(L)||0); if(xcg==null) xcg=L/2;
        items.push({name:name,length:L,weight:W,xcg_local:xcg,tCode:tCode});
        pushSeg(tCode,d,L,idx);
      }
      if(t==='P'){
        var L=Number(el('lenIn').value)||0, wpi=Number(el('wpi').value)||W_PER_IN_DEFAULT;
        placeLinear('24" pipe',L,wpi*L,null,'P'); addItemSummary(idx+'. Pipe '+L.toFixed(1)+' in @ '+wpi+' → '+(wpi*L).toFixed(1)+' lb');
      }else if(t==='X'){
        var Lx=Number(el('lenIn').value)||0, wpiX=Number(el('wpi').value)||W_PER_IN_DEFAULT;
        placeLinear('Custom per-inch',Lx,wpiX*Lx,null,'X'); addItemSummary(idx+'. Custom per-inch '+Lx.toFixed(1)+' in @ '+wpiX);
      }else if(t==='Y'){
        var W=Number(el('fixedW').value)||0, Lf=Number(el('fixedL').value)||0;
        placeLinear('Custom fixed',Lf,W,null,'Y'); addItemSummary(idx+'. Custom fixed '+W.toFixed(1)+' lb, eff L '+Lf.toFixed(1)+' in');
      }else if(t==='V'){
        placeLinear('Valve (regular)',L_VALVE_STD,W_VALVE_BODY,L_VALVE_STD/2,'V'); addItemSummary(idx+'. Valve reg '+L_VALVE_STD+' in @ '+W_VALVE_BODY+' lb');
      }else if(t==='I'){
        placeLinear('Valve (inline)',L_VALVE_INLINE,W_VALVE_INLINE,L_VALVE_INLINE/2,'I'); addItemSummary(idx+'. Valve inline '+L_VALVE_INLINE+' in @ '+W_VALVE_INLINE+' lb');
      }else if(t==='E'){
        placeLinear('90° elbow',S_EL90,W_EL90,S_EL90/2,'E'); addItemSummary(idx+'. 90° elbow '+S_EL90+' in @ '+W_EL90+' lb');
      }else if(t==='F'){
        placeLinear('45° elbow',S_EL45,W_EL45,S_EL45/2,'F'); addItemSummary(idx+'. 45° elbow '+S_EL45+' in @ '+W_EL45+' lb');
      }else if(t==='T'){
        placeLinear('Tee (plain)',L_TEE,W_TEE_BODY,L_TEE/2,'T'); addItemSummary(idx+'. Tee '+L_TEE+' in @ '+W_TEE_BODY+' lb');
      }else if(t==='W'){
        var partsW=[[W_TEE_BODY,L_TEE/2],[W_VALVE_BODY,L_TEE/2]], Wsum=partsW.reduce((a,p)=>a+p[0],0), xcgw=partsW.reduce((a,p)=>a+p[0]*p[1],0)/Wsum;
        placeLinear('Tee + valve',L_TEE,Wsum,xcgw,'W'); addItemSummary(idx+'. Tee+valve '+L_TEE+' in @ '+Wsum.toFixed(1)+' lb');
      }
      // auto-couplings weight only at joints (at compute time)
      if(debugDiv) debugDiv.textContent='debug: items='+items.length;
      populateContactDropdowns();
    }catch(e){ if(debugDiv) debugDiv.textContent='debug: addItem error '+e; }
  }

  function populateContactDropdowns(){
    var opts = segments.map((s,i)=>{
      var len = dist3(s.start,s.end);
      var lbl = (i+1)+'. '+(items[i]?items[i].name:('Seg '+(i+1)))+' (L='+len.toFixed(1)+' in)';
      return {i:i, label: lbl, len: len};
    });
    ['AL_seg','AR_seg','BL_seg','BR_seg'].forEach(id=>{
      var sel = el(id); if(!sel) return; sel.innerHTML='';
      opts.forEach(o=>{ var op=document.createElement('option'); op.value=o.i; op.textContent=o.label; sel.appendChild(op); });
    });
  }

  function dist3(a,b){ var dx=b[0]-a[0], dy=b[1]-a[1], dz=b[2]-a[2]; return Math.sqrt(dx*dx+dy*dy+dz*dz); }
  function add(a,b){ return [a[0]+b[0],a[1]+b[1],a[2]+b[2]]; }
  function sub(a,b){ return [a[0]-b[0],a[1]-b[1],a[2]-b[2]]; }
  function mul(a,k){ return [a[0]*k,a[1]*k,a[2]*k]; }
  function dot(a,b){ return a[0]*b[0]+a[1]*b[1]+a[2]*b[2]; }
  function norm(a){ var d=Math.sqrt(dot(a,a)); return d>0? mul(a,1/d):[0,0,0]; }
  function cross(a,b){ return [a[1]*b[2]-a[2]*b[1], a[2]*b[0]-a[0]*b[2], a[0]*b[1]-a[1]*b[0]]; }

  function pointOnSegment(seg, offset){
    var L=dist3(seg.start,seg.end); if(L<=0) return seg.start.slice();
    var t=Math.max(0, Math.min(1, (offset||0)/L));
    return add(seg.start, mul( sub(seg.end,seg.start), t ));
  }

  function compute(){
    if(items.length===0){ alert('Add at least one item.'); return; }

    // weights + CG with auto-couplings at joints
    var totalW=0,sum=[0,0,0];
    for(var i=0;i<items.length;i++){ totalW+=items[i].weight; sum=add(sum, mul([marks[i][1],marks[i][2],marks[i][3]], items[i].weight)); }
    for(var j=0;j<segments.length-1;j++){ var end=segments[j].end; totalW+=W_COUP; sum=add(sum, mul(end, W_COUP)); }
    var CG = totalW>0 ? mul(sum,1/totalW) : [0,0,0];

    var mode = el('mode').value;
    var od = Number(el('pipeOD').value)||PIPE_OD_DEFAULT;
    var sheaveD = Number(el('sheaveD').value)||12;
    var allowTop = Number(el('allowTop').value)||6;        // per side (in)
    var allowLoop = Number(el('allowLoop').value)||24;     // per basket (in)
    var lenTop = (Number(el('lenTopFt').value)||20)*12;    // in
    var lenLoop = (Number(el('lenLoopFt').value)||20)*12;  // in

    // Contacts
    function readContact(selId, offId){
      var si = Number(el(selId).value)||0, off=Number(el(offId).value)||0; var seg=segments[si];
      var L=dist3(seg.start,seg.end); off=Math.max(0, Math.min(L, off));
      return {segIndex:si, offset:off, p: pointOnSegment(seg, off)};
    }
    var AL=readContact('AL_seg','AL_off'), AR=readContact('AR_seg','AR_off');
    var BL=readContact('BL_seg','BL_off'), BR=readContact('BR_seg','BR_off');

    // 2-pick quick path (kept for convenience)
    if(mode==='2'){
      var pickSpacing = Math.max(0, Number(el('pickSpacing').value)||72);
      var axes=el('axes').value;
      var ext=function(axisIdx){
        var arr=[]; segments.forEach(s=>{arr.push(s.start[axisIdx], s.end[axisIdx]);});
        var mn=Math.min.apply(null,arr), mx=Math.max.apply(null,arr);
        return {min:mn,max:mx,span:mx-mn};
      };
      var which='X'; if(axes==='AUTO'){ var spans=[['X',ext(0).span],['Y',ext(1).span],['Z',ext(2).span]].sort((a,b)=>b[1]-a[1]); which=spans[0][0]; }
      else which=axes;
      var ex = ext(which==='X'?0:which==='Y'?1:2), cgAxis=(which==='X'?CG[0]:which==='Y'?CG[1]:CG[2]);
      var Lc=Math.max(ex.min, Math.min(ex.max-pickSpacing, cgAxis-pickSpacing/2)), Rc=Lc+pickSpacing;
      draw2Pick(Lc,Rc,which,CG);
      summaryDiv.innerHTML = '<h3>2-Pick</h3><ul><li>CG: X='+CG[0].toFixed(2)+', Y='+CG[1].toFixed(2)+', Z='+CG[2].toFixed(2)+' in</li><li>Left '+fmtFtIn(Lc-ex.min)+' from Min '+which+' Edge</li><li>Right '+fmtFtIn(Rc-ex.min)+' from Min '+which+' Edge</li></ul>';
      return;
    }

    // 4-point with pulleys + baskets (automatic heights)
    // Pulley plan XY at midpoint of its two contacts
    function mid2(a,b){ return mul(add(a,b),0.5); }
    var PAxy = mid2(AL.p, AR.p); var PBxy = mid2(BL.p, BR.p);

    // Solve pulley Z so |P-AL| + |P-AR| + allowance = lenLoop
    function solvePulleyZ(Pxy, C1, C2){
      var target = lenLoop - allowLoop;
      var zlo = Math.min(C1.p[2],C2.p[2]) - 300; // generous bounds
      var zhi = Math.max(C1.p[2],C2.p[2]) + 300;
      function f(z){ var P=[Pxy[0],Pxy[1],z]; return dist3(P,C1.p)+dist3(P,C2.p) - target; }
      var lo=zlo, hi=zhi, flo=f(lo), fhi=f(hi);
      for(var it=0; it<80; it++){
        var mid=(lo+hi)/2, fm=f(mid);
        if(fm===0 || Math.abs(hi-lo)<1e-4) return mid;
        if((fm>0 && flo>0) || (fm<0 && flo<0)){ lo=mid; flo=fm; } else { hi=mid; fhi=fm; }
      }
      return (lo+hi)/2;
    }
    var PAz = solvePulleyZ(PAxy, AL, AR);
    var PBz = solvePulleyZ(PBxy, BL, BR);
    var PA=[PAxy[0],PAxy[1],PAz], PB=[PBxy[0],PBxy[1],PBz];

    // Hook from two spheres: |H-PA| = lenTop-allowTop, |H-PB| = lenTop-allowTop
    var RA = lenTop - allowTop, RB = lenTop - allowTop;
    function hookFromSpheres(PA, PB, RA, RB){
      var d = dist3(PA, PB);
      if(d < Math.abs(RA-RB) || d > (RA+RB)){ return null; } // no intersection
      var ex = norm( sub(PB,PA) );
      var a = (RA*RA - RB*RB + d*d)/(2*d);
      var p = add(PA, mul(ex,a));
      var h2 = RA*RA - a*a; if(h2<0) h2=0;
      var rc = Math.sqrt(h2);
      var aux = [0,0,1]; if(Math.abs(dot(ex,aux))>0.9) aux=[0,1,0];
      var ey = norm( sub(aux, mul(ex, dot(aux,ex))) );
      var ez = cross(ex, ey);
      var cand1 = add(p, mul(ez, rc));
      var cand2 = add(p, mul(ez, -rc));
      var best = cand1[2] >= cand2[2] ? cand1 : cand2; // choose highest-Z
      return best;
    }
    var H = hookFromSpheres(PA, PB, RA, RB);
    var topFeasible = (H!==null);

    // Unit vectors contact->pulley
    function uVec(C, P){ return norm( sub(P, C.p) ); }
    var u_AL=uVec(AL,PA), u_AR=uVec(AR,PA), u_BL=uVec(BL,PB), u_BR=uVec(BR,PB);

    // Least-squares solve for TA, TB (basket tensions) to minimize force+moment residuals
    function colAdd(a,b){ return [a[0]+b[0],a[1]+b[1],a[2]+b[2]]; }
    var U_A = colAdd(u_AL, u_AR);
    var U_B = colAdd(u_BL, u_BR);
    function momentCol(C1,u1,C2,u2){
      var r1=sub(C1.p, CG), r2=sub(C2.p, CG);
      return [ cross(r1,u1)[0]+cross(r2,u2)[0],
               cross(r1,u1)[1]+cross(r2,u2)[1],
               cross(r1,u1)[2]+cross(r2,u2)[2] ];
    }
    var M_A = momentCol(AL,u_AL,AR,u_AR);
    var M_B = momentCol(BL,u_BL,BR,u_BR);
    // Stack into 6x2 system A*[TA,TB] ≈ b
    var A = [
      [U_A[0], U_B[0]], [U_A[1], U_B[1]], [U_A[2], U_B[2]],
      [M_A[0], M_B[0]], [M_A[1], M_B[1]], [M_A[2], M_B[2]]
    ];
    var b = [0,0,totalW, 0,0,0]; // desire vertical force = W, zero elsewhere
    function ls2(A,b){
      var ATb=[0,0], ATA=[[0,0],[0,0]];
      for(var r=0;r<A.length;r++){
        ATb[0]+=A[r][0]*b[r]; ATb[1]+=A[r][1]*b[r];
        ATA[0][0]+=A[r][0]*A[r][0]; ATA[0][1]+=A[r][0]*A[r][1];
        ATA[1][0]+=A[r][1]*A[r][0]; ATA[1][1]+=A[r][1]*A[r][1];
      }
      var det=ATA[0][0]*ATA[1][1]-ATA[0][1]*ATA[1][0];
      if(Math.abs(det)<1e-9) return [0,0];
      var inv=[[ ATA[1][1]/det, -ATA[0][1]/det],
               [-ATA[1][0]/det,  ATA[0][0]/det]];
      return [ inv[0][0]*ATb[0]+inv[0][1]*ATb[1], inv[1][0]*ATb[0]+inv[1][1]*ATb[1] ];
    }
    var sol = ls2(A,b); var TA=Math.max(0,sol[0]), TB=Math.max(0,sol[1]);

    // Residuals
    function vec2(Acol, tA, Bcol, tB){ return [Acol[0]*tA+Bcol[0]*tB, Acol[1]*tA+Bcol[1]*tB, Acol[2]*tA+Bcol[2]*tB]; }
    var Fsum = vec2(U_A,TA,U_B,TB);
    var Msum = vec2(M_A,TA,M_B,TB);
    var rollPitchNote = 'moments residual |M|='+Math.sqrt(dot(Msum,Msum)).toFixed(1)+' in·lb';

    // Leg lengths (shares) per basket with solved pulleys
    function legLen(P,C){ return dist3(P,C.p); }
    var AL_len=legLen(PA,AL), AR_len=legLen(PA,AR), BL_len=legLen(PB,BL), BR_len=legLen(PB,BR);
    var A_total = AL_len + AR_len + allowLoop;
    var B_total = BL_len + BR_len + allowLoop;

    // Summary HTML
    var html = '';
    html += '<h3>CG & Geometry</h3><ul>';
    html += '<li>CG: X='+CG[0].toFixed(2)+' in, Y='+CG[1].toFixed(2)+' in, Z='+CG[2].toFixed(2)+' in</li>';
    html += '<li>Pulley A: ('+PA.map(v=>v.toFixed(2)).join(', ')+') in; Loop check '+(A_total>0? ( (Math.abs(A_total-lenLoop)<0.25)?'OK':'Δ '+(A_total-lenLoop).toFixed(2)+' in' ):'')+'</li>';
    html += '<li>Pulley B: ('+PB.map(v=>v.toFixed(2)).join(', ')+') in; Loop check '+(B_total>0? ( (Math.abs(B_total-lenLoop)<0.25)?'OK':'Δ '+(B_total-lenLoop).toFixed(2)+' in' ):'')+'</li>';
    html += '<li>Hook: '+(topFeasible? '('+H.map(v=>v.toFixed(2)).join(', ')+') in':'<b>Not feasible</b> (check top length/allowances)')+'</li>';
    html += '</ul>';

    html += '<h3>Contacts (tape-ready)</h3><ul>';
    function contactLine(tag,C){
      var s=segments[C.segIndex]; var L=dist3(s.start,s.end);
      return '<li>'+tag+': Seg '+(C.segIndex+1)+' @ '+fmtFtIn(C.offset)+' from start face; global ('+C.p.map(v=>v.toFixed(2)).join(', ')+') in</li>';
    }
    html += contactLine('<span class="pill A">A-L</span>',AL);
    html += contactLine('<span class="pill A">A-R</span>',AR);
    html += contactLine('<span class="pill B">B-L</span>',BL);
    html += contactLine('<span class="pill B">B-R</span>',BR);
    html += '</ul>';

    html += '<h3>Tensions & Balance</h3><ul>';
    html += '<li>A basket tension T<sub>A</sub> ≈ '+TA.toFixed(0)+' lb; B basket tension T<sub>B</sub> ≈ '+TB.toFixed(0)+' lb</li>';
    html += '<li>Top chokers ≈ ('+(2*TA).toFixed(0)+' lb, '+(2*TB).toFixed(0)+' lb) (per pulley)</li>';
    html += '<li>Force residual: ['+Fsum.map(x=>x.toFixed(0)).join(', ')+'] vs [0,0,'+totalW.toFixed(0)+']</li>';
    html += '<li>'+rollPitchNote+'</li>';
    html += '</ul>';

    html += '<h3>Leg shares (of 20′ loop)</h3><ul>';
    html += '<li>A-L '+fmtFtIn(AL_len)+'; A-R '+fmtFtIn(AR_len)+'; wraps/bends '+fmtFtIn(allowLoop)+' → sum '+fmtFtIn(A_total)+'</li>';
    html += '<li>B-L '+fmtFtIn(BL_len)+'; B-R '+fmtFtIn(BR_len)+'; wraps/bends '+fmtFtIn(allowLoop)+' → sum '+fmtFtIn(B_total)+'</li>';
    html += '</ul>';

    summaryDiv.innerHTML = html;

    // Draw
    drawAll(CG, PA, PB, H, {AL,AR,BL,BR});
    el('downloadBtn').disabled=false;
  }

  function drawAll(CG, PA, PB, H, C){
    var W=1000,Hh=1200,pad=28, secH=Math.floor((Hh-pad*4)/2);
    ctx.clearRect(0,0,sheet.width,sheet.height);
    var planRect={x:pad,y:pad,w:W-2*pad,h:secH};
    var elevRect={x:pad,y:pad*2+secH,w:W-2*pad,h:secH};

    // bounds
    var verts=[[0,0,0]]; segments.forEach(s=>verts.push(s.end.slice()));
    verts.push(PA,PB); if(H) verts.push(H);
    var px=verts.map(v=>v[0]), py=verts.map(v=>v[1]), pz=verts.map(v=>v[2]);
    var minX=Math.min.apply(null,px.concat([0])), maxX=Math.max.apply(null,px.concat([1]));
    var minY=Math.min.apply(null,py.concat([-1])), maxY=Math.max.apply(null,py.concat([1]));
    var minZ=Math.min.apply(null,pz.concat([-1])), maxZ=Math.max.apply(null,pz.concat([1]));

    function drawProjection(rect, getY, title){
      var pad2=46;
      var sx=(rect.w-pad2*2)/((maxX-minX)||1);
      var sy=(rect.h-pad2*2)/((getY(maxY)-getY(minY))||1);
      var s=Math.min(sx,sy);
      function mapX(x){ return rect.x+pad2+(x-minX)*s; }
      function mapY(y){ return rect.y+rect.h-pad2-(getY(y)-getY(minY))*s; }

      ctx.fillStyle='#000'; ctx.font='20px system-ui'; ctx.fillText(title, rect.x, rect.y-6);

      // Axes
      ctx.lineWidth=2;
      ctx.strokeStyle=COLORS.axisX; ctx.beginPath(); ctx.moveTo(mapX(minX), mapY(0)); ctx.lineTo(mapX(maxX), mapY(0)); ctx.stroke();
      var otherZero = mapX(0);
      ctx.strokeStyle=(getY===((v)=>v)?COLORS.axisY:COLORS.axisZ);
      ctx.beginPath(); ctx.moveTo(otherZero, mapY(getY(minY))); ctx.lineTo(otherZero, mapY(getY(maxY))); ctx.stroke();

      var thick=Math.min(30, Math.max(8, s*24*0.6));
      ctx.lineCap='round';

      // pipe bands
      segments.forEach(seg=>{
        var sx0=mapX(seg.start[0]), sy0=mapY(getY(seg.start[ getY===((v)=>v)?1:2 ]));
        var sx1=mapX(seg.end[0]),   sy1=mapY(getY(seg.end[   getY===((v)=>v)?1:2 ]));
        ctx.strokeStyle=COLORS.pipeBand; ctx.lineWidth=thick; ctx.beginPath(); ctx.moveTo(sx0,sy0); ctx.lineTo(sx1,sy1); ctx.stroke();
      });
      // centerlines
      segments.forEach(seg=>{
        var sx0=mapX(seg.start[0]), sy0=mapY(getY(seg.start[ getY===((v)=>v)?1:2 ]));
        var sx1=mapX(seg.end[0]),   sy1=mapY(getY(seg.end[   getY===((v)=>v)?1:2 ]));
        ctx.strokeStyle=COLORS[seg.tCode]||COLORS.centerline; ctx.lineWidth=3; ctx.beginPath(); ctx.moveTo(sx0,sy0); ctx.lineTo(sx1,sy1); ctx.stroke();
      });
      // labels
      ctx.fillStyle='#000'; ctx.font='14px system-ui';
      marks.forEach(mk=>{ var x=mk[1], y=getY(mk[2]); ctx.fillText(String(mk[0]), mapX(x)+4, mapY(y)-16); });

      // contacts & pulleys
      function drawPoint(p, color, label){
        ctx.fillStyle=color; ctx.strokeStyle=color;
        ctx.beginPath(); ctx.arc(mapX(p[0]), mapY(getY(p[1])), 4, 0, Math.PI*2); ctx.fill();
        ctx.fillStyle='#000'; ctx.font='12px system-ui'; ctx.fillText(label, mapX(p[0])+6, mapY(getY(p[1]))-14);
      }
      function drawLine(p,q,color){
        ctx.strokeStyle=color; ctx.lineWidth=2; ctx.beginPath(); ctx.moveTo(mapX(p[0]), mapY(getY(p[1]))); ctx.lineTo(mapX(q[0]), mapY(getY(q[1]))); ctx.stroke();
      }

      // Contacts
      drawPoint(C.AL.p, COLORS.A, 'A-L'); drawPoint(C.AR.p, COLORS.A, 'A-R');
      drawPoint(C.BL.p, COLORS.B, 'B-L'); drawPoint(C.BR.p, COLORS.B, 'B-R');

      // Pulleys
      drawPoint(PA, COLORS.A, 'Pulley A'); drawPoint(PB, COLORS.B, 'Pulley B');

      // Basket legs
      drawLine(C.AL.p, PA, COLORS.A); drawLine(C.AR.p, PA, COLORS.A);
      drawLine(C.BL.p, PB, COLORS.B); drawLine(C.BR.p, PB, COLORS.B);

      // Hook + top chokers
      if(H){
        drawPoint(H, '#444', 'Hook');
        drawLine(H, PA, '#888'); drawLine(H, PB, '#888');
      }

      ctx.strokeStyle='#cfd4d9'; ctx.lineWidth=1; ctx.strokeRect(rect.x,rect.y,rect.w,rect.h);
    }

    drawProjection(planRect, (y)=>y, 'Plan (X–Y)');
    drawProjection(elevRect, (z)=>z, 'Elevation (X–Z)');
  }

  function draw2Pick(Lc,Rc,axis,CG){
    var W=1000,Hh=800,pad=28;
    ctx.clearRect(0,0,sheet.width,sheet.height);
    var rect={x:pad,y:pad,w:W-2*pad,h:Hh-2*pad};
    var px=segments.map(s=>s.end[0]).concat([0]), py=segments.map(s=>s.end[1]).concat([0]);
    var minX=Math.min.apply(null,px), maxX=Math.max.apply(null,px);
    var minY=Math.min.apply(null,py), maxY=Math.max.apply(null,py);
    var pad2=46, sx=(rect.w-pad2*2)/((maxX-minX)||1), sy=(rect.h-pad2*2)/((maxY-minY)||1), s=Math.min(sx,sy);
    function mapX(x){ return rect.x+pad2+(x-minX)*s; } function mapY(y){ return rect.y+rect.h-pad2-(y-minY)*s; }
    ctx.fillStyle='#000'; ctx.font='20px system-ui'; ctx.fillText('2-Pick Plan (X–Y)', rect.x, rect.y-6);
    segments.forEach(seg=>{ var sx0=mapX(seg.start[0]), sy0=mapY(seg.start[1]); var sx1=mapX(seg.end[0]), sy1=mapY(seg.end[1]);
      ctx.strokeStyle=COLORS.pipeBand; ctx.lineWidth=20; ctx.beginPath(); ctx.moveTo(sx0,sy0); ctx.lineTo(sx1,sy1); ctx.stroke();
      ctx.strokeStyle=COLORS[seg.tCode]||COLORS.centerline; ctx.lineWidth=3; ctx.beginPath(); ctx.moveTo(sx0,sy0); ctx.lineTo(sx1,sy1); ctx.stroke();
    });
    ctx.strokeStyle=COLORS.A; ctx.lineWidth=2; ctx.beginPath(); ctx.moveTo(mapX(Lc), mapY(0)); ctx.lineTo(mapX(Lc), mapY(0)-30); ctx.stroke();
    ctx.strokeStyle=COLORS.B; ctx.beginPath(); ctx.moveTo(mapX(Rc), mapY(0)); ctx.lineTo(mapX(Rc), mapY(0)-30); ctx.stroke();
    ctx.strokeStyle='#cfd4d9'; ctx.lineWidth=1; ctx.strokeRect(rect.x,rect.y,rect.w,rect.h);
  }

  // Wiring
  function updateDetailRows(){
    var t=el('itemType').value;
    el('lenRow').style.display = (t==='P'||t==='X')?'grid':'none';
    el('fixedRow').style.display = (t==='Y')?'grid':'none';
    el('single90Row').style.display = (t==='G')?'grid':'none';
    if(t!=='X') el('wpi').value=W_PER_IN_DEFAULT;
  }

  function wireOnce(){
    var addBtn=el('addBtn'); if(addBtn && !addBtn.dataset.bound){ addBtn.dataset.bound='1'; addBtn.addEventListener('click', addItem); }
    var clearBtn=el('clearBtn'); if(clearBtn && !clearBtn.dataset.bound){ clearBtn.dataset.bound='1'; clearBtn.addEventListener('click', resetAll); }
    var computeBtn=el('computeBtn'); if(computeBtn && !computeBtn.dataset.bound){ computeBtn.dataset.bound='1'; computeBtn.addEventListener('click', compute); }
    var downloadBtn=el('downloadBtn'); if(downloadBtn && !downloadBtn.dataset.bound){
      downloadBtn.dataset.bound='1';
      downloadBtn.addEventListener('click', function(){ var a=document.createElement('a'); var ts=new Date().toISOString().slice(0,19).replace(/[:T]/g,'-'); a.download=ts+'_rigging.png'; a.href=el('sheet').toDataURL('image/png'); a.click(); });
    }
    var typeEl=el('itemType'); if(typeEl && !typeEl.dataset.bound){ typeEl.dataset.bound='1'; typeEl.addEventListener('change', updateDetailRows); }
  }

  window.addEventListener('load', function(){
    wireOnce(); updateDetailRows(); populateContactDropdowns();
    var b=document.getElementById('badge'); if(b) b.textContent='Ready v11';
    if(debugDiv) debugDiv.textContent='debug: ready (v11)';
  });
}
</script>
</body>
</html>
